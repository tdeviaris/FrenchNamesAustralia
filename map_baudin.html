<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baudin Map - French Names Along the Australian Coastline</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Garamond:wght@400;700&family=Lato:wght@300;400&display=swap');
        body { font-family: 'Lato', sans-serif; margin: 0; background-color: #f4f4f4; color: #333; }
        .container { width: 100%; max-width: none; margin: 0; padding: 12px 20px 28px; box-sizing: border-box; }
        @media (max-width: 768px) {
            .container { padding: 10px 12px 24px; }
        }
        nav { background-color: #333; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; padding: 6px 18px; gap: 12px; }
        nav ul { list-style: none; margin: 0; padding: 0; display: flex; gap: 6px; }
        nav ul li a { display: block; color: white; text-decoration: none; padding: 12px 22px; font-size: 1.05rem; border-radius: 4px; }
        nav ul li a.active, nav ul li a:hover { background-color: #0056b3; }
        .lang-switcher { margin-left: auto; color: white; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; }
        .lang-switcher button { background: none; border: none; color: inherit; cursor: pointer; padding: 5px; font: inherit; }
        .lang-switcher button.active { font-weight: bold; color: #FFD700; text-decoration: underline; }
        .lang-switcher button:focus-visible { outline: 2px solid #FFD700; outline-offset: 2px; }
        .lang-switcher .lang-separator { opacity: 0.7; }
        .content-section { background-color: white; padding: 14px 16px 18px; margin-top: 8px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .content-section h2 { font-family: 'Lato', sans-serif; font-size: 1.9rem; font-weight: 700; text-align: center; margin: 4px 0 10px; }
        .map-container { height: min(720px, calc(100vh - 220px)); width: 100%; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-top: 10px; }
        .map-wrapper { position: relative; }
        .map-spinner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            transition: opacity 0.3s ease;
        }
        .map-spinner.hidden { opacity: 0; pointer-events: none; }
        .map-spinner::after {
            content: "";
            width: 48px;
            height: 48px;
            border: 4px solid #cfd8dc;
            border-top-color: #0056b3;
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .map-info-control {
            background: rgba(255,255,255,0.92);
            padding: 6px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            margin: 0 0 14px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
            color: #333;
            font-family: 'Lato', sans-serif;
            pointer-events: none;
        }
        .map-info-coordinates { white-space: nowrap; }
        .map-info-scale-wrapper { display: flex; align-items: flex-end; }
        .map-info-scale-wrapper .leaflet-control-scale {
            margin: 0;
            background: transparent;
        }
        .map-info-scale-wrapper .leaflet-control-scale-line {
            background: transparent;
            color: #333;
            border: 2px solid #555;
            border-bottom: none;
            padding: 2px 8px 0;
            border-radius: 4px 4px 0 0;
            box-shadow: none;
        }
        .historic-maps-section { margin-top: 30px; }
        .historic-maps-section h3 { text-align: center; font-family: 'Lato', sans-serif; font-size: 2rem; margin-top: 40px; }
        .historic-map img { width: 100%; height: auto; border-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        footer { background-color: #333; color: white; text-align: center; padding: 20px; margin-top: 40px; }
        .leaflet-popup-content-wrapper { border-radius: 5px; } .leaflet-popup-content { font-size: 0.9rem; line-height: 1.5; width: auto !important; }
        .leaflet-popup-content p { margin: 5px 0; } .leaflet-popup-content strong { color: #0056b3; }
        
        /* Styles pour la mise en page de la popup */
        .popup-layout {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        .popup-text-container {
            width: 280px;
            flex-shrink: 0;
        }
        .popup-image-wrapper {
            flex-basis: clamp(240px, 38vw, 360px);
            flex-shrink: 0;
        }
        .popup-image-button {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            width: 100%;
            display: block;
        }
        .popup-image-button:focus-visible {
            outline: 2px solid #FFD700;
            outline-offset: 2px;
        }
        .popup-image-wrapper .popup-image {
            width: 100%;
            height: auto;
            border-radius: 6px;
            display: block;
        }
        @media (max-width: 768px) {
            nav { flex-direction: column; align-items: stretch; padding: 8px 12px; }
            nav ul { flex-direction: column; width: 100%; gap: 0; }
            nav ul li a { width: 100%; text-align: center; padding: 12px 0; border-radius: 0; border-top: 1px solid rgba(255,255,255,0.15); }
            nav ul li:first-child a { border-top: none; }
            .lang-switcher { margin-left: 0; justify-content: center; padding-top: 6px; }
            .popup-layout {
                flex-direction: column;
                align-items: stretch;
            }
            .popup-text-container {
                width: 100%;
            }
            .popup-image-wrapper {
                flex-basis: auto;
                width: 100%;
            }
            .popup-image-wrapper .popup-image {
                max-width: 100%;
            }
        }
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
            box-sizing: border-box;
        }
        .image-modal.open { display: flex; }
        .image-modal img {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            background: #fff;
        }
        .image-modal button {
            position: absolute;
            top: 18px;
            right: 18px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: none;
            font-size: 1.5rem;
            line-height: 1;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .image-modal button:focus-visible {
            outline: 2px solid #FFD700;
            outline-offset: 2px;
        }
        .map-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 24px;
            box-sizing: border-box;
        }
        .map-modal.open { display: flex; }
        .map-modal-content {
            background: #fff;
            width: 96vw;
            max-width: 1150px;
            max-height: 92vh;
            display: flex;
            flex-direction: column;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            overflow: hidden;
        }
        .map-modal-header {
            padding: 12px 16px;
            background: #f7f7f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .map-modal-title {
            font-family: 'Lato', sans-serif;
            font-size: 0.95rem;
            font-weight: 400;
            margin: 0;
            color: #333;
        }
        .map-modal-close {
            background: none;
            border: none;
            font-size: 1.6rem;
            line-height: 1;
            cursor: pointer;
            color: #333;
        }
        .map-modal-close:focus-visible {
            outline: 2px solid #0056b3;
            outline-offset: 2px;
        }
        .map-modal-body {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            overflow: hidden;
        }
        .map-modal-body iframe,
        .map-modal-body embed,
        .map-modal-body object {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
        }
        .map-modal-body img {
            max-width: 96vw;
            max-height: 90vh;
            object-fit: contain;
            display: block;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="index.html" id="nav-home">Home</a></li>
                <li><a href="map_dentrecasteaux.html" id="nav-map-dentre">d'Entrecasteaux Map</a></li>
                <li><a href="map_baudin.html" class="active" id="nav-map-baudin">Baudin Map</a></li>
                <li><a href="resources.html" id="nav-resources">Resources</a></li>
            </ul>
            <div class="lang-switcher"><button type="button" id="lang-fr">FR</button><span aria-hidden="true" class="lang-separator">|</span><button type="button" id="lang-en">EN</button></div>
        </nav>
    </header>

    <main class="container">
         <section class="content-section">
            <h2 id="baudin-title">Baudin Map (1800-1804)</h2>
            <div class="map-wrapper">
                <div class="map-spinner" id="map-spinner" role="status" aria-live="polite" aria-label="Loading map"></div>
                <div id="map" class="map-container"></div>
            </div>
        </section>
        
        <section class="historic-maps-section">
            <div class="historic-map">
                <h3 id="map-title-baudin">Map from Baudin expedition, 1802</h3>
                <!-- NOM DE FICHIER CORRIGÉ -->
                <img src="img/carte-de-baudin-1802.jpg" alt="Historical map from Baudin expedition, 1802">
            </div>
        </section>
    </main>

    <div id="image-modal" class="image-modal" aria-hidden="true" role="dialog" aria-modal="true">
        <button type="button" id="image-modal-close" aria-label="Fermer l'image">&times;</button>
        <img src="" alt="" id="image-modal-image">
    </div>

    <div id="map-modal" class="map-modal" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="map-modal-content">
            <div class="map-modal-header">
                <h3 class="map-modal-title" id="map-modal-title"></h3>
                <button type="button" class="map-modal-close" id="map-modal-close" aria-label="Close map">&times;</button>
            </div>
            <div class="map-modal-body" id="map-modal-body"></div>
        </div>
    </div>

    <div data-include-footer></div>
    <script src="js/translations.js"></script>
    <script src="js/main.js"></script>
    <script>
        const defaultCenter = [-30.5, 135];
        const defaultZoom = 4;
        const focusZoomLevel = 8;
        const popupTopMargin = 32;
        const popupBottomMargin = 32;

        const map = L.map('map').setView(defaultCenter, defaultZoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(map);

        const scaleControl = L.control.scale({ position: 'bottomleft', metric: true, imperial: false });
        scaleControl.addTo(map);

        let coordinatesElement;
        const mapInfoControl = L.control({ position: 'bottomleft' });
        mapInfoControl.onAdd = () => {
            const container = L.DomUtil.create('div', 'map-info-control');
            coordinatesElement = L.DomUtil.create('div', 'map-info-coordinates', container);
            coordinatesElement.textContent = 'Lat: --°  Lon: --°';

            const scaleWrapper = L.DomUtil.create('div', 'map-info-scale-wrapper', container);
            const scaleContainer = scaleControl._container;
            if (scaleContainer) {
                scaleContainer.classList.remove('leaflet-control');
                scaleWrapper.appendChild(scaleContainer);
            }

            return container;
        };
        mapInfoControl.addTo(map);

        const updateCoordinates = (event) => {
            if (!coordinatesElement) {
                return;
            }
            const { lat, lng } = event.latlng;
            coordinatesElement.textContent = `Lat: ${lat.toFixed(4)}°  Lon: ${lng.toFixed(4)}°`;
        };

        map.on('mousemove', updateCoordinates);
        map.on('mouseout', () => {
            if (coordinatesElement) {
                coordinatesElement.textContent = 'Lat: --°  Lon: --°';
            }
        });

        const nameForTooltip = (place, lang) => {
            if (!place) {
                return '';
            }
            if (lang === 'fr') {
                return (place.frenchName || place.ausEName || '').trim();
            }
            return (place.ausEName || place.frenchName || '').trim();
        };

        const isFiniteNumber = (value) => (Number.isFinite ? Number.isFinite(value) : isFinite(value));
        const escapeHtml = (value = '') => String(value).replace(/[&<>"']/g, (char) => {
            const chars = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
            return chars[char] || char;
        });

        const extractCoordinates = (place) => {
            const lat = Number(place.lat);
            const lon = Number(place.lon);

            if (!isFiniteNumber(lat) || !isFiniteNumber(lon) || lat === 0 || lon === 0) {
                return null;
            }

            return [lat, lon];
        };
        const formatCoordinates = (lat, lon, trans) => {
            const latValue = Math.abs(lat).toFixed(3);
            const lonValue = Math.abs(lon).toFixed(3);
            const latDir = lat > 0 ? trans['direction-north'] : trans['direction-south'];
            const lonDir = lon > 0 ? trans['direction-east'] : trans['direction-west'];
            return `${latValue}° ${latDir}; ${lonValue}° ${lonDir}`;
        };

        const modal = document.getElementById('image-modal');
        const modalImage = document.getElementById('image-modal-image');
        const modalCloseButton = document.getElementById('image-modal-close');

        const mapModal = document.getElementById('map-modal');
        const mapModalBody = document.getElementById('map-modal-body');
            const mapModalTitle = document.getElementById('map-modal-title');
            const mapModalCloseButton = document.getElementById('map-modal-close');

        const closeImageModal = () => {
            if (!modal) { return; }
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
            modalImage.src = '';
            modalImage.alt = '';
        };

        const openImageModal = (src, alt) => {
            if (!modal || !modalImage) { return; }
            modalImage.src = src;
            modalImage.alt = alt;
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            if (modalCloseButton) {
                modalCloseButton.focus({ preventScroll: true });
            }
        };

        const closeMapModal = () => {
            if (!mapModal) { return; }
            mapModal.classList.remove('open');
            mapModal.setAttribute('aria-hidden', 'true');
            if (mapModalBody) {
                mapModalBody.innerHTML = '';
            }
            if (mapModalTitle) {
                mapModalTitle.textContent = '';
            }
        };

        const openMapModal = (url, title) => {
            if (!mapModal || !mapModalBody) { return; }
            const normalizedUrl = (() => {
                if (!url) { return ''; }
                const hasRepresentativeImage = /representativeimage/i.test(url);
                if (!hasRepresentativeImage) {
                    return url;
                }
                const hasQuery = url.includes('?');
                const widParam = hasQuery ? '&wid=2000' : '?wid=2000';
                if (/wid=\d+/i.test(url)) {
                    return url;
                }
                return url + widParam;
            })();

            mapModalBody.innerHTML = '';
            const isImage = /\.(jpg|jpeg|png|gif|webp)(\?|$)/i.test(normalizedUrl) || /representativeimage/i.test(normalizedUrl);
            let contentNode;
            if (isImage) {
                contentNode = document.createElement('img');
                contentNode.src = normalizedUrl;
                contentNode.alt = title || '';
            } else {
                contentNode = document.createElement('iframe');
                contentNode.src = normalizedUrl;
                contentNode.title = title || 'Map viewer';
                contentNode.setAttribute('loading', 'lazy');
            }
            mapModalBody.appendChild(contentNode);

            if (mapModalTitle) {
                mapModalTitle.textContent = title || '';
            }
            mapModal.classList.add('open');
            mapModal.setAttribute('aria-hidden', 'false');
            if (mapModalCloseButton) {
                mapModalCloseButton.focus({ preventScroll: true });
            }
        };

        if (modal) {
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeImageModal();
                }
            });
        }
        if (modalCloseButton) {
            modalCloseButton.addEventListener('click', closeImageModal);
        }
        if (mapModal) {
            mapModal.addEventListener('click', (event) => {
                if (event.target === mapModal) {
                    closeMapModal();
                }
            });
        }
        if (mapModalCloseButton) {
            mapModalCloseButton.addEventListener('click', closeMapModal);
        }
        document.addEventListener('keydown', (event) => {
            const escapePressed = event.key === 'Escape';
            if (!escapePressed) {
                return;
            }
            if (modal?.classList.contains('open')) {
                closeImageModal();
                return;
            }
            if (mapModal?.classList.contains('open')) {
                closeMapModal();
            }
        });

        const adjustPopupView = (popup, attempt = 0) => {
            const marker = popup._source;
            if (!marker) {
                return;
            }

            const targetLatLng = marker.getLatLng();
            const targetZoom = Math.max(map.getZoom(), focusZoomLevel);
            const popupElement = popup.getElement();

            if (!popupElement && attempt < 5) {
                requestAnimationFrame(() => adjustPopupView(popup, attempt + 1));
                return;
            }

            let centerLatLng = targetLatLng;

            if (popupElement) {
                const mapSize = map.getSize();
                const popupHeight = popupElement.offsetHeight;
                const anchorHeight = popupElement.querySelector('.leaflet-popup-tip')?.offsetHeight || 0;

                if (popupHeight) {
                    const markerPixel = map.project(targetLatLng, targetZoom);
                    let desiredMarkerY = markerPixel.y;
                    const popupTop = desiredMarkerY - (popupHeight - anchorHeight);
                    const popupBottom = desiredMarkerY + anchorHeight;

                    if (popupTop < popupTopMargin) {
                        desiredMarkerY += popupTopMargin - popupTop;
                    }
                    if (popupBottom > mapSize.y - popupBottomMargin) {
                        desiredMarkerY -= popupBottom - (mapSize.y - popupBottomMargin);
                    }

                    const centerPixel = [
                        markerPixel.x,
                        markerPixel.y + (mapSize.y / 2) - desiredMarkerY
                    ];
                    centerLatLng = map.unproject(centerPixel, targetZoom);
                }
            }

            const currentCenter = map.getCenter();
            const isSameCenter = currentCenter.distanceTo(centerLatLng) < 1e-6;
            const currentZoom = map.getZoom();

            if (isSameCenter && currentZoom === targetZoom) {
                return;
            }

            map.flyTo(centerLatLng, targetZoom, { duration: 0.45, easeLinearity: 0.2 });
        };

        const attachPopupActions = (popup, attempt = 0) => {
            const popupElement = popup.getElement();
            if (!popupElement && attempt < 5) {
                requestAnimationFrame(() => attachPopupActions(popup, attempt + 1));
                return;
            }
            if (!popupElement) {
                return;
            }
            const button = popupElement.querySelector('.popup-image-button');
            const image = popupElement.querySelector('.popup-image-wrapper .popup-image');
            if (button && image) {
                if (!button.dataset.modalBound) {
                    button.addEventListener('click', () => openImageModal(image.src, image.alt));
                    button.dataset.modalBound = 'true';
                }

                const ensureAdjusted = () => adjustPopupView(popup);
                if (image.complete) {
                    requestAnimationFrame(ensureAdjusted);
                } else {
                    image.addEventListener('load', ensureAdjusted, { once: true });
                }
            }

            const mapLink = popupElement.querySelector('.popup-map-link');
            if (mapLink && !mapLink.dataset.modalBound) {
                mapLink.addEventListener('click', (event) => {
                    event.preventDefault();
                    const url = mapLink.dataset.mapUrl;
                    const title = mapLink.dataset.mapTitle || '';
                    if (url && url.trim() !== '') {
                        openMapModal(url, title);
                    }
                });
                mapLink.dataset.modalBound = 'true';
            }
        };

        map.on('popupopen', (event) => {
            adjustPopupView(event.popup);
            attachPopupActions(event.popup);
        });

        const mapSpinner = document.getElementById('map-spinner');

        const hideSpinner = () => {
            if (mapSpinner) {
                mapSpinner.classList.add('hidden');
                setTimeout(() => mapSpinner.remove(), 500);
            }
        };

        const dataVersion = '20250209';
        const dataUrl = `data/baudin.json?v=${dataVersion}`;

        fetch(dataUrl, { cache: 'no-cache' })
            .then(response => response.json())
            .then(places => {
                hideSpinner();
                const bounds = L.latLngBounds();

                places.forEach(place => {
                    const coordinates = extractCoordinates(place);
                    if (!coordinates) {
                        return;
                    }

                    const [lat, lon] = coordinates;
                    const marker = L.marker([lat, lon]).addTo(map);
                    bounds.extend([lat, lon]);

                    marker.bindTooltip('', {
                        direction: 'top',
                        offset: [0, -10],
                        opacity: 0.95,
                        sticky: true
                    });

                    const refreshTooltip = () => {
                        const currentLang = localStorage.getItem('language') || 'en';
                        const tooltipName = nameForTooltip(place, currentLang);
                        if (!tooltipName) {
                            marker.closeTooltip();
                            return;
                        }
                        marker.setTooltipContent(tooltipName);
                    };

                    marker.on('mouseover', () => {
                        refreshTooltip();
                        if (marker.getTooltip()) {
                            marker.openTooltip();
                        }
                    });
                    marker.on('mouseout', () => marker.closeTooltip());

                    marker.bindPopup(() => {
                        const currentLang = localStorage.getItem('language') || 'en';
                        const trans = translations[currentLang];
                        const safeAlt = escapeHtml(place.frenchName || '');

                        let textHtml = `<p><strong>${trans['popup-french-name']}</strong> ${place.frenchName}</p>
<p><strong>${trans['popup-ause-name']}</strong> ${place.ausEName}</p>`;

                        if (place.indigenousName && place.indigenousName.trim() !== "") {
                            textHtml += `<p><strong>${trans['popup-indigenous-name']} ${place.indigenousLanguage} :</strong> ${place.indigenousName}</p>`;
                        }

                        const coordinatesText = formatCoordinates(lat, lon, trans);
                        textHtml += `<p><strong>${trans['popup-coordinates']}</strong> ${coordinatesText}</p>`;

                        // Characteristic
                        const characteristicText = (currentLang === 'fr' && place.characteristic_fr) ? place.characteristic_fr : place.characteristic;
                        if (characteristicText && characteristicText.trim() !== "") {
                            textHtml += `<p><strong>${trans['popup-characteristic-label']}</strong> ${characteristicText}</p>`;
                        }

                        // Origin of the name
                        const historyText = (currentLang === 'fr' && place.history_fr) ? place.history_fr : place.history;
                        if (historyText && historyText.trim() !== "") {
                            textHtml += `<p><strong>${trans['popup-history-label']}</strong> ${historyText}</p>`;
                        }

                        // Wikipedia link
                        const wikiLink = (currentLang === 'fr') ? place.wiki_fr : place.wiki_en;
                        if (wikiLink && wikiLink.trim() !== "") {
                            let linkText = wikiLink.substring(wikiLink.lastIndexOf('/') + 1);
                            linkText = decodeURIComponent(linkText).replace(/_/g, ' ');
                            textHtml += `<p><strong>${trans['popup-wiki-label']}</strong> <a href="${wikiLink}" target="_blank">${linkText}</a></p>`;
                        }

                        // Other source link
                        if (place.other_link && place.other_link.trim() !== "") {
                            textHtml += `<p><strong>${trans['popup-othersource-label']}</strong> <a href="${place.other_link}" target="_blank">${place.other_link}</a></p>`;
                        }

                        // Map source link
                        if (place.mapUrl && place.mapUrl.trim() !== "") {
                            const mapTitle = (currentLang === 'fr' && place.mapTitle_fr) ? place.mapTitle_fr : place.mapTitle_en;
                            const safeMapTitle = mapTitle && mapTitle.trim() !== '' ? escapeHtml(mapTitle) : escapeHtml(place.frenchName || '');
                            textHtml += `<p><a href="#" class="popup-map-link" data-map-url="${place.mapUrl}" data-map-title="${safeMapTitle}">${trans['popup-map-link']}</a></p>`;
                        }

                        // Details link
                        const detailsUrl = (currentLang === 'fr') ? place.detailsLink : (place.detailsLink_en || place.detailsLink);
                        if (detailsUrl && detailsUrl.trim() !== "" && detailsUrl.trim() !== "#") {
                            textHtml += `<p><a href="${detailsUrl}" target="_blank">${trans['popup-details-link']}</a></p>`;
                        }

                        // Si une image est disponible, créer une mise en page à deux colonnes.
                        if (place.imgUrl && place.imgUrl.trim() !== "") {
                            const imageHtml = `
                                <div class="popup-image-wrapper">
                                    <button type="button" class="popup-image-button" aria-label="${trans['popup-image-expand-label']}">
                                        <img src="${place.imgUrl}" alt="${safeAlt}" class="popup-image">
                                    </button>
                                </div>`;

                            return `<div class="popup-layout">
                                        <div class="popup-text-container">${textHtml}</div>
                                        ${imageHtml}
                                    </div>`;
                        }

                        // Sinon, retourner uniquement le texte dans un conteneur de largeur fixe.
                        return `<div class="popup-text-container">${textHtml}</div>`;
                    });
                });

                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [40, 40], maxZoom: focusZoomLevel });
                } else {
                    map.setView(defaultCenter, defaultZoom);
                }
            })
            .catch(error => {
                console.error('Failed to load baudin data:', error);
                hideSpinner();
            });
    </script>
</body>
</html>
