<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expert Toponymes - Assistant IA</title>
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon16.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;600;700&display=swap');

        :root {
            --nav-height: 72px;
            --primary-blue: #0056b3;
            --light-blue: #e3f2fd;
            --dark-bg: #1f1f1f;
            --gray-bg: #f5f5f5;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Lato', sans-serif;
            background-color: #999;
            padding-top: var(--nav-height);
        }

        nav {
            background: var(--dark-bg);
            color: #fff;
            position: fixed;
            inset: 0 0 auto 0;
            height: var(--nav-height);
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 clamp(18px, 4vw, 40px);
            box-shadow: 0 4px 18px rgba(0,0,0,0.2);
        }

        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: clamp(8px, 2vw, 18px);
        }

        nav ul li a {
            display: block;
            color: inherit;
            text-decoration: none;
            padding: 10px 18px;
            font-size: 1.05rem;
            border-radius: 999px;
            transition: background 0.2s ease;
        }

        nav ul li a.active,
        nav ul li a:hover {
            background-color: var(--primary-blue);
        }

        .lang-switcher {
            position: absolute;
            right: clamp(18px, 4vw, 40px);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .lang-switcher button {
            background-color: transparent;
            border: none;
            color: inherit;
            cursor: pointer;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .lang-switcher button:hover {
            background-color: rgba(0, 86, 179, 0.4);
        }

        .lang-switcher button.active {
            background-color: var(--primary-blue);
        }

        .lang-switcher button img {
            display: block;
            width: 28px;
            height: auto;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .expert-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 30px;
            min-height: calc(100vh - var(--nav-height) - 80px);
            display: flex;
            flex-direction: column;
        }

        .expert-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .expert-header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin: 0 0 10px 0;
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 10px;
        }

        .expert-header p {
            font-size: 1.1rem;
            color: #666;
            margin: 10px 0 0 0;
        }

        .info-banner {
            background: var(--light-blue);
            border-left: 4px solid var(--primary-blue);
            padding: 15px 20px;
            margin-bottom: 25px;
            border-radius: 4px;
            font-size: 0.95rem;
            color: #1565c0;
            line-height: 1.6;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            min-height: 500px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
            text-align: right;
        }

        .message-content {
            display: inline-block;
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 18px;
            line-height: 1.6;
        }

        .message-user .message-content {
            background: var(--primary-blue);
            color: white;
        }

        .message-assistant .message-content {
            background: white;
            color: #333;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            text-align: left;
        }

        .message-assistant .message-content p {
            margin: 0 0 10px 0;
        }

        .message-assistant .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-assistant .message-content a {
            color: var(--primary-blue);
            text-decoration: underline;
            font-weight: 500;
        }

        .message-assistant .message-content a:hover {
            color: #003f82;
        }

        .message-assistant .message-content ul,
        .message-assistant .message-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .message-assistant .message-content li {
            margin: 5px 0;
        }

        .message-assistant .message-content strong {
            font-weight: 600;
        }

        .message-assistant .message-content h1,
        .message-assistant .message-content h2,
        .message-assistant .message-content h3,
        .message-assistant .message-content h4 {
            margin: 15px 0 10px 0;
            font-weight: 600;
            color: #333;
        }

        .message-assistant .message-content h1 {
            font-size: 1.5em;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 5px;
        }

        .message-assistant .message-content h2 {
            font-size: 1.3em;
        }

        .message-assistant .message-content h3 {
            font-size: 1.15em;
            color: var(--primary-blue);
        }

        .message-assistant .message-content h4 {
            font-size: 1.05em;
        }

        .message-assistant .message-content br {
            display: block;
            content: "";
            margin: 5px 0;
        }

        .typing-indicator {
            display: inline-block;
            padding: 12px 18px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #ddd;
        }

        .chat-input-form {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid #ddd;
            border-radius: 24px;
            font-size: 1rem;
            font-family: 'Lato', sans-serif;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--primary-blue);
        }

        .chat-send-button {
            padding: 12px 24px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .chat-send-button:hover:not(:disabled) {
            background: #003f82;
        }

        .chat-send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .error-message {
            background: #ffebee;
            border-left: 4px solid #d32f2f;
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 4px;
            color: #c62828;
        }

        @media (max-width: 768px) {
            :root { --nav-height: 52px; }
            nav { height: var(--nav-height); padding: 0 8px; }
            nav ul { gap: 4px; }
            nav ul li a { padding: 4px 8px; font-size: 0.75rem; }
            .lang-switcher { position: static; gap: 3px; }
            .lang-switcher button { width: 26px; height: 26px; }
            .lang-switcher button img { width: 16px; }
            .container { padding: 10px; }
            .expert-container { padding: 20px; }
            .expert-header h1 { font-size: 1.5rem; }
            .expert-header p { font-size: 0.95rem; }
            .message-content { max-width: 90%; }
        }
    </style>
</head>
<body>
    <nav>
        <ul>
            <li><a href="index.html" id="nav-home">Home</a></li>
            <li><a href="map_dentrecasteaux.html" id="nav-map-dentre">d'Entrecasteaux</a></li>
            <li><a href="map_baudin.html" id="nav-map-baudin">Baudin</a></li>
            <li><a href="resources.html" id="nav-resources">Resources</a></li>
            <li><a href="expert.html" class="active" id="nav-expert">AI Expert</a></li>
        </ul>
        <div class="lang-switcher">
            <button type="button" id="lang-fr" title="Passer en Français">
                <img src="img/fr.svg" alt="Français">
            </button>
            <button type="button" id="lang-en" title="Switch to English">
                <img src="img/au.svg" alt="English">
            </button>
        </div>
    </nav>

    <main class="container">
        <div class="expert-container">
            <div class="expert-header">
                <h1 data-i18n="expert-title">Expert Toponymes - AI Assistant</h1>
                <p data-i18n="expert-subtitle">Ask your questions about French place names in Australia</p>
            </div>

            <div class="info-banner" data-i18n="expert-info">
                This specialized AI assistant can answer your questions about the Baudin and d'Entrecasteaux expeditions, French place names in Australia, and the history of these voyages of exploration.
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="message message-assistant">
                        <div class="message-content">
                            <p data-i18n="expert-welcome">Hello! I'm the expert on French toponyms in Australia. Ask me anything about the expeditions of d'Entrecasteaux (1791-1794) and Baudin (1800-1804), the 670 documented place names, or the explorers and scientists who participated in these voyages.</p>
                        </div>
                    </div>
                </div>

                <div class="chat-input-container">
                    <form class="chat-input-form" id="chat-form">
                        <input
                            type="text"
                            class="chat-input"
                            id="chat-input"
                            placeholder="Ask your question..."
                            data-i18n-placeholder="expert-input-placeholder"
                            autocomplete="off"
                        >
                        <button type="submit" class="chat-send-button" id="send-button" data-i18n="expert-send">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <div data-include-footer></div>

    <script src="js/translations.js?v=20241012"></script>
    <script src="js/main.js?v=20241012"></script>
    <script>
        // Configuration de l'URL de l'API
        // En développement local avec Vercel CLI: http://localhost:3000/api/chat
        // En production: utilise automatiquement l'URL actuelle (fonctionne avec preview et production)
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000/api/chat'
            : `${window.location.origin}/api/chat`

        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');

        let threadId = null; // Pour l'API Assistants
        let isProcessing = false;

        // Fonction pour nettoyer et formater le contenu
        function cleanAndFormatContent(content) {
            // 1. Supprimer les citations sources 【...†...】
            content = content.replace(/【[^】]*】/g, '');

            // 2. Nettoyer les espaces multiples
            content = content.replace(/\s+/g, ' ').trim();

            return content;
        }

        // Fonction pour convertir le Markdown en HTML
        function markdownToHtml(text) {
            // D'abord, nettoyer les balises HTML mal formées ou partielles
            text = text.replace(/<a\s+href="([^"]*)"[^>]*>([^<]*)<\/a>/gi, '[$2]($1)');
            text = text.replace(/(<\/?[a-z][^>]*>)/gi, ''); // Supprimer autres balises HTML

            // Nettoyer les attributs HTML orphelins
            text = text.replace(/"\s*target="_blank"\s*rel="[^"]*"/g, '');
            text = text.replace(/>\s*$/gm, '');

            // Titres (avant le gras pour éviter les conflits)
            text = text.replace(/^####\s+(.+)$/gm, '<h4>$1</h4>');
            text = text.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
            text = text.replace(/^##\s+(.+)$/gm, '<h2>$1</h2>');
            text = text.replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');

            // Gras
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/__(.+?)__/g, '<strong>$1</strong>');

            // Italique (mais pas dans les URLs)
            text = text.replace(/(?<!https?:\/\/[^\s]*)\*([^\*]+?)\*(?![^\s]*\))/g, '<em>$1</em>');
            text = text.replace(/(?<!https?:\/\/[^\s]*)_([^_]+?)_(?![^\s]*\))/g, '<em>$1</em>');

            // Liens Markdown [texte](url) - décoder les URLs
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(match, linkText, url) {
                // Décoder l'URL pour la rendre lisible
                const decodedUrl = decodeURIComponent(url);
                return `<a href="${url}" target="_blank" rel="noopener noreferrer">${linkText}</a>`;
            });

            // URLs nues (https://... sans markdown) - ne traiter que si pas déjà dans un lien
            text = text.replace(/(?<!href=["'])(?<!>)(https?:\/\/[^\s<"']+)(?![^<]*<\/a>)/g, function(match) {
                // Décoder l'URL pour l'affichage
                const displayUrl = decodeURIComponent(match);
                // Extraire juste le domaine et le chemin pour un affichage plus court
                const shortUrl = displayUrl.replace(/^https?:\/\//, '').substring(0, 50);
                return `<a href="${match}" target="_blank" rel="noopener noreferrer">${shortUrl}${displayUrl.length > 50 ? '...' : ''}</a>`;
            });

            // Listes à puces
            text = text.replace(/^[\-\*]\s+(.+)$/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

            // Listes numérotées
            text = text.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');

            // Retours à la ligne simples (transformer \n en <br> sauf si déjà dans une balise)
            text = text.replace(/\n/g, '<br>');

            return text;
        }

        // Fonction pour ajouter un message
        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'message-user' : 'message-assistant'}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (isUser) {
                contentDiv.textContent = content;
            } else {
                // Nettoyer le contenu (supprimer citations)
                content = cleanAndFormatContent(content);

                // Convertir les retours à la ligne en paragraphes
                const paragraphs = content.split('\n\n');
                paragraphs.forEach(para => {
                    if (para.trim()) {
                        const p = document.createElement('p');
                        // Appliquer le formatage Markdown
                        p.innerHTML = markdownToHtml(para.trim());
                        contentDiv.appendChild(p);
                    }
                });
            }

            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            return contentDiv;
        }

        // Fonction pour afficher l'indicateur de frappe
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message message-assistant';
            typingDiv.id = 'typing-indicator';

            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';

            typingDiv.appendChild(indicator);
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Fonction pour masquer l'indicateur de frappe
        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Fonction pour afficher une erreur
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            chatMessages.appendChild(errorDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Gérer la soumission du formulaire
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (isProcessing || !chatInput.value.trim()) {
                return;
            }

            const userMessage = chatInput.value.trim();
            chatInput.value = '';

            // Ajouter le message de l'utilisateur
            addMessage(userMessage, true);

            // Désactiver l'input pendant le traitement
            isProcessing = true;
            chatInput.disabled = true;
            sendButton.disabled = true;

            // Afficher l'indicateur de frappe
            showTypingIndicator();

            try {
                // Appeler l'API
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        threadId: threadId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Masquer l'indicateur de frappe
                hideTypingIndicator();

                // Créer un message vide pour l'assistant
                const assistantMessage = addMessage('');
                let fullResponse = '';

                // Lire le stream SSE
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);

                            if (data === '[DONE]') {
                                break;
                            }

                            try {
                                const parsed = JSON.parse(data);

                                // Sauvegarder le threadId s'il est fourni
                                if (parsed.threadId) {
                                    threadId = parsed.threadId;
                                }

                                if (parsed.content) {
                                    fullResponse += parsed.content;

                                    // Nettoyer et mettre à jour le message progressivement
                                    const cleanedResponse = cleanAndFormatContent(fullResponse);
                                    assistantMessage.innerHTML = '';

                                    const paragraphs = cleanedResponse.split('\n\n');
                                    paragraphs.forEach(para => {
                                        if (para.trim()) {
                                            const p = document.createElement('p');
                                            // Appliquer le formatage Markdown
                                            p.innerHTML = markdownToHtml(para.trim());
                                            assistantMessage.appendChild(p);
                                        }
                                    });

                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                }
                            } catch (e) {
                                // Ignorer les erreurs de parsing
                            }
                        }
                    }
                }

                // L'historique est maintenant géré par le thread OpenAI
                // Pas besoin de le sauvegarder côté client

            } catch (error) {
                console.error('Error:', error);
                hideTypingIndicator();
                showError('Error: Unable to reach the AI assistant. Please try again later.');
            } finally {
                isProcessing = false;
                chatInput.disabled = false;
                sendButton.disabled = false;
                chatInput.focus();
            }
        });

        // Gérer les traductions pour le placeholder
        document.addEventListener('languageChanged', () => {
            const currentLang = localStorage.getItem('language') || 'en';
            const placeholderKey = chatInput.getAttribute('data-i18n-placeholder');

            if (placeholderKey && translations[currentLang][placeholderKey]) {
                chatInput.placeholder = translations[currentLang][placeholderKey];
            }
        });
    </script>
</body>
</html>
