<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>d'Entrecasteaux Map - French Names Along the Australian Coastline</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Garamond:wght@400;700&family=Lato:wght@300;400&display=swap');
        body { font-family: 'Lato', sans-serif; margin: 0; background-color: #f4f4f4; color: #333; }
        .container { width: 100%; max-width: none; margin: 0; padding: 12px 20px 28px; box-sizing: border-box; }
        @media (max-width: 768px) {
            .container { padding: 10px 12px 24px; }
        }
        nav { background-color: #333; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: center; align-items: center; padding: 0 20px; }
        nav ul { list-style: none; margin: 0; padding: 0; display: flex; }
        nav ul li a { display: block; color: white; text-decoration: none; padding: 15px 25px; font-size: 1.1rem; }
        nav ul li a.active, nav ul li a:hover { background-color: #0056b3; }
        .lang-switcher { margin-left: auto; color: white; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; }
        .lang-switcher button { background: none; border: none; color: inherit; cursor: pointer; padding: 5px; font: inherit; }
        .lang-switcher button.active { font-weight: bold; color: #FFD700; text-decoration: underline; }
        .lang-switcher button:focus-visible { outline: 2px solid #FFD700; outline-offset: 2px; }
        .lang-switcher .lang-separator { opacity: 0.7; }
        .content-section { background-color: white; padding: 16px 18px 20px; margin-top: 12px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .content-section h2 { font-family: 'Garamond', serif; font-size: 2.35rem; border-bottom: 2px solid #0056b3; padding-bottom: 6px; margin-bottom: 12px; }
        .map-container { height: 650px; width: 100%; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-top: 12px; }
        footer { background-color: #333; color: white; text-align: center; padding: 20px; margin-top: 40px; }
        .leaflet-popup-content-wrapper { border-radius: 5px; } .leaflet-popup-content { font-size: 0.9rem; line-height: 1.5; width: auto !important; }
        .leaflet-popup-content p { margin: 5px 0; } .leaflet-popup-content strong { color: #0056b3; }
        
        /* Styles pour la mise en page de la popup */
        .popup-layout {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        .popup-text-container {
            width: 280px; /* Largeur fixe pour le texte, avec ou sans image */
            flex-shrink: 0; /* Empêche le texte de se réduire */
        }
        .popup-image-wrapper {
            flex-basis: 260px; /* Largeur de l'image (130px * 2) */
            flex-shrink: 0;
        }
        .popup-image-button {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            width: 100%;
        }
        .popup-image-button:focus-visible {
            outline: 2px solid #FFD700;
            outline-offset: 2px;
        }
        .popup-image-wrapper .popup-image {
            width: 100%;
            height: auto;
            border-radius: 4px;
            border: 4px solid #ffffff;
            background-color: #ffffff;
            box-sizing: border-box;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
            box-sizing: border-box;
        }
        .image-modal.open { display: flex; }
        .image-modal img {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            background: #fff;
        }
        .image-modal button {
            position: absolute;
            top: 18px;
            right: 18px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: none;
            font-size: 1.5rem;
            line-height: 1;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .image-modal button:focus-visible {
            outline: 2px solid #FFD700;
            outline-offset: 2px;
        }
        /* Style pour les paragraphes de texte additionnel */
        .additional-text p { margin-bottom: 1em; text-align: justify; }
        .additional-text .references { font-size: 0.8em; margin-top: 2em; }
    </style>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="index.html" id="nav-home">Home</a></li>
                <li><a href="map_dentrecasteaux.html" class="active" id="nav-map-dentre">d'Entrecasteaux Map</a></li>
                <li><a href="map_baudin.html" id="nav-map-baudin">Baudin Map</a></li>
                <li><a href="resources.html" id="nav-resources">Resources</a></li>
            </ul>
            <div class="lang-switcher"><button type="button" id="lang-fr">FR</button><span aria-hidden="true" class="lang-separator">|</span><button type="button" id="lang-en">EN</button></div>
        </nav>
    </header>

    <main class="container">
        <section class="content-section">
            <h2 id="dentre-title">d'Entrecasteaux Map (1791-1793)</h2>
            <!-- Le paragraphe de description initial -->
            <p id="dentre-desc">Explore the place names given during the expedition of Antoine Bruny d'Entrecasteaux, who charted in great detail the coasts of Tasmania in search of La Pérouse. Click on a marker to discover more information.</p>
            <div id="map" class="map-container"></div>
        </section>

        <!-- Section de texte complémentaire -->
        <section class="content-section additional-text">
            <!-- Premier paragraphe de l'ancien texte -->
            <p id="dentre-text-p1">The first object of the d’Entrecastreaux expedition, the search for the missing Lapérouse, ended in failure. They found no trace of his two ships or their crew on any islands in the western Pacific they sighted. However, the second parts of the expedition’s mission, the mapping of coasts in the Southern Lands still partially unknown to Europeans, proved highly successful. These discoveries gave new hope and motivation to the crew after a difficult crossing of the southern Indian Ocean in rough sea. D'Entrecasteaux's nomenclature bestowed along the coasts of what is now known as Tasmania and Western Australia pays tribute to his deserving crew who made these discoveries possible, and the voyage in general.</p>
            <!-- Deuxième paragraphe de l'ancien texte -->
            <p id="dentre-text-p2">The east coasts of Van Diemen Land (Tasmania) coasts were visited in April-May 1792 and again in late January-February 1793, and the south-west coasts of New Holland (Western Australia) in late December 1792 - January 1793.</p>
            <hr style="margin: 2em 0;">
            <!-- NOUVEAU TEXTE DÉTAILLÉ -->
            <p id="dentre-text-p3">68 places were named along these coasts by d’Entrecasteaux and, after the voyage, for a couple of them, by Rossel*. They have been subdivided into two sections: the names on the east coasts of Van Diemen Land (Tasmania) coasts visited in April-May 1792 and again in late January-February 1793, and the names along the south-west coasts of New Holland (Western Australia) in late December 1792 - January 1793.</p>
            <p id="dentre-text-p4">It had not been an easy task for the commander to find common ground between nautical issues, the schedule of his itinerary, surveying and hydrographical work, and the focus of his savants on natural history and the discovery of new species. The naturalists were often complaining that the officers were given precedence (for example, they, the savants, had to wait far longer than the officers for the coxswain) and occasionally the relationships between officers and savants deteriorated enough to create an incident (For example, in January 1793, exasperated by the botanist Labillardière*, the officer Bonvouloir threw two bottles at the savant who was eating his breakfast). This task was made the more arduous for d’Entrecasteaux and his successors by the divergent requirements of the naturalists and by the political divisions between the savants. Labillardière, Riche* and, after some hesitation, Ventenat*, were republicans while others supported the royalist’s cause. Despite these various political hues, d’Entrecasteaux fostered the work of his naturalists and encouraged them to specialise in different specific areas to avoid duplication and interference with each other’s research work. In addition, by drawing attention on the discovery and natural history mission of his voyage, d’Entrecasteaux enhanced the zeal of his officers. In his memoirs, Jurien de La Gravière* reported that ‘the naturalists inoculate us with the passion for collections. Everyone on board had its own. The search for shells was the dominant one. The savants are worried about potential rivals who might discover new species and steal their thunder. They address their complaints to the Amiral, and he asked us to submit to them the result of all our fishing. This order, as you can imagine, had the sole effect to make us hide our treasures more closely than ever’[1].</p>
            <p id="dentre-text-p5">Officers, such as Jurien, and savants like the Benedictine chaplain Ambroise Pierson* were of a conciliatory disposition, and most of the sailors were not focusing on politics. Together, they contributed to ease tensions among the crew.</p>
            <p id="dentre-text-p6">The places visited and named by the d’Entrecasteaux expedition were obviously already well-known, identified and labelled in some way or another by the local aboriginal communities. Yet, despite the crew encountering some of them on several occasions[2], the French did not make inquiries of the aborigines on how they named their land and the names of the places surveyed by the members of the expedition. This one-sided naming practice was linked to the European concept of ‘first discovery’, and the fantasies of the European Enlightenment which suggested to the visitors that natives (at least the natives they met in Tasmania in friendly terms) were ‘noble savages’ living in an original ‘primitive’ state uncorrupted by civilization and ignorant of scientific and technical developments in Europe.</p>
            <div class="references">
                <p>[1] Jurien de La Gravière, P.-R., Jurien de La Gravière, J.-P.-E. Editor (1860) Souvenirs d'un amiral, Volume 1. Hachette et cie, p.114.</p>
                <p>[2] Especially in Tasmania, named Lutruwita by its inhabitants. Daugeron, B. (2014) À la recherche de l'Espérance. Revisiter la rencontre des Aborigènes tasmaniens avec les Français (1772-1802). Ars Apodemica.</p>
            </div>
        </section>
    </main>

    <div id="image-modal" class="image-modal" aria-hidden="true" role="dialog" aria-modal="true">
        <button type="button" id="image-modal-close" aria-label="Fermer l'image">&times;</button>
        <img src="" alt="" id="image-modal-image">
    </div>

    <div data-include-footer></div>
    <script src="js/translations.js"></script>
    <script src="js/main.js"></script>
    <script>
        const defaultCenter = [-30.5, 135];
        const defaultZoom = 4;
        const focusZoomLevel = 8;
        const popupTopMargin = 32;
        const popupBottomMargin = 32;
        const popupAnchorOffset = 70;

        const map = L.map('map').setView(defaultCenter, defaultZoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(map);

        const isFiniteNumber = (value) => (Number.isFinite ? Number.isFinite(value) : isFinite(value));
        const escapeHtml = (value = '') => String(value).replace(/[&<>"']/g, (char) => {
            const chars = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
            return chars[char] || char;
        });

        const extractCoordinates = (place) => {
            const lat = Number(place.lat);
            const lon = Number(place.lon);

            if (!isFiniteNumber(lat) || !isFiniteNumber(lon) || lat === 0 || lon === 0) {
                return null;
            }

            return [lat, lon];
        };
        const formatCoordinates = (lat, lon, trans) => {
            const latValue = Math.abs(lat).toFixed(3);
            const lonValue = Math.abs(lon).toFixed(3);
            const latDir = lat > 0 ? trans['direction-north'] : trans['direction-south'];
            const lonDir = lon > 0 ? trans['direction-east'] : trans['direction-west'];
            return `${latValue}° ${latDir}; ${lonValue}° ${lonDir}`;
        };

        const modal = document.getElementById('image-modal');
        const modalImage = document.getElementById('image-modal-image');
        const modalCloseButton = document.getElementById('image-modal-close');

        const closeImageModal = () => {
            if (!modal) { return; }
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
            modalImage.src = '';
            modalImage.alt = '';
        };

        const openImageModal = (src, alt) => {
            if (!modal || !modalImage) { return; }
            modalImage.src = src;
            modalImage.alt = alt;
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            if (modalCloseButton) {
                modalCloseButton.focus({ preventScroll: true });
            }
        };

        if (modal) {
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeImageModal();
                }
            });
        }
        if (modalCloseButton) {
            modalCloseButton.addEventListener('click', closeImageModal);
        }
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && modal?.classList.contains('open')) {
                closeImageModal();
            }
        });

        const adjustPopupView = (popup, attempt = 0) => {
            const marker = popup._source;
            if (!marker) {
                return;
            }

            const targetLatLng = marker.getLatLng();
            const targetZoom = Math.max(map.getZoom(), focusZoomLevel);
            const popupElement = popup.getElement();

            if (!popupElement && attempt < 5) {
                requestAnimationFrame(() => adjustPopupView(popup, attempt + 1));
                return;
            }

            let centerLatLng = targetLatLng;

            if (popupElement) {
                const mapSize = map.getSize();
                const popupHeight = popupElement.offsetHeight;
                const anchorHeight = popupElement.querySelector('.leaflet-popup-tip')?.offsetHeight || 0;
                const effectivePopupHeight = popupHeight - anchorHeight + popupAnchorOffset;

                const mapHalf = mapSize.y / 2;
                let desiredPixelY = mapHalf;

                if (mapHalf - effectivePopupHeight < popupTopMargin) {
                    desiredPixelY = Math.min(mapSize.y - popupBottomMargin, effectivePopupHeight + popupTopMargin);
                }

                const deltaY = mapHalf - desiredPixelY;
                if (deltaY !== 0) {
                    const targetPixel = map.project(targetLatLng, targetZoom);
                    const centerPixel = targetPixel.add([0, deltaY]);
                    centerLatLng = map.unproject(centerPixel, targetZoom);
                }
            }

            const currentCenter = map.getCenter();
            const isSameCenter = currentCenter.distanceTo(centerLatLng) < 1e-6;
            const currentZoom = map.getZoom();

            if (isSameCenter && currentZoom === targetZoom) {
                return;
            }

            map.flyTo(centerLatLng, targetZoom, { duration: 0.45, easeLinearity: 0.2 });
        };

        const attachPopupImageHandler = (popup, attempt = 0) => {
            const popupElement = popup.getElement();
            if (!popupElement && attempt < 5) {
                requestAnimationFrame(() => attachPopupImageHandler(popup, attempt + 1));
                return;
            }
            if (!popupElement) {
                return;
            }
            const button = popupElement.querySelector('.popup-image-button');
            const image = popupElement.querySelector('.popup-image-wrapper .popup-image');
            if (button && image) {
                if (!button.dataset.modalBound) {
                    button.addEventListener('click', () => openImageModal(image.src, image.alt));
                    button.dataset.modalBound = 'true';
                }
            }
        };

        map.on('popupopen', (event) => {
            adjustPopupView(event.popup);
            attachPopupImageHandler(event.popup);
        });

        map.on('popupopen', (event) => {
            adjustPopupView(event.popup);
        });

        fetch('data/entrecasteaux.json')
            .then(response => response.json())
            .then(places => {
                const bounds = L.latLngBounds();

                places.forEach(place => {
                    const coordinates = extractCoordinates(place);
                    if (!coordinates) {
                        return;
                    }

                    const [lat, lon] = coordinates;
                    const marker = L.marker([lat, lon]).addTo(map);
                    bounds.extend([lat, lon]);
                    marker.bindPopup(() => {
                        const currentLang = localStorage.getItem('language') || 'en';
                        const trans = translations[currentLang];

                        let textHtml = `<p><strong>${trans['popup-french-name']}</strong> ${place.frenchName}</p>
<p><strong>${trans['popup-ause-name']}</strong> ${place.ausEName}</p>`;

                        if (place.indigenousName && place.indigenousName.trim() !== "") {
                            textHtml += `<p><strong>${trans['popup-indigenous-name']} ${place.indigenousLanguage} :</strong> ${place.indigenousName}</p>`;
                        }

                        const coordinatesText = formatCoordinates(lat, lon, trans);
                        textHtml += `<p><strong>${trans['popup-coordinates']}</strong> ${coordinatesText}</p>`;

                        // Characteristic
                        const characteristicText = (currentLang === 'fr' && place.characteristic_fr) ? place.characteristic_fr : place.characteristic;
                        if (characteristicText && characteristicText.trim() !== "") {
                            textHtml += `<p><strong>${trans['popup-characteristic-label']}</strong> ${characteristicText}</p>`;
                        }

                        // Origin of the name
                        const originText = (currentLang === 'fr' && place.origin_fr) ? place.origin_fr : place.origin;
                        if (originText && originText.trim() !== "") {
                            textHtml += `<p><strong>${trans['popup-origin-label']}</strong> ${originText}</p>`;
                        }

                        // Wikipedia link
                        const wikiLink = (currentLang === 'fr') ? place.wiki_fr : place.wiki_en;
                        if (wikiLink && wikiLink.trim() !== "") {
                            let linkText = wikiLink.substring(wikiLink.lastIndexOf('/') + 1);
                            linkText = decodeURIComponent(linkText).replace(/_/g, ' ');
                            textHtml += `<p><strong>${trans['popup-wiki-label']}</strong> <a href="${wikiLink}" target="_blank">${linkText}</a></p>`;
                        }

                        // Other source link
                        if (place.other_link && place.other_link.trim() !== "") {
                            textHtml += `<p><strong>${trans['popup-othersource-label']}</strong> <a href="${place.other_link}" target="_blank">${place.other_link}</a></p>`;
                        }

                        // Details link
                        if (place.detailsLink && place.detailsLink.trim() !== "" && place.detailsLink.trim() !== "#") {
                            textHtml += `<p><a href="${place.detailsLink}" target="_blank">${trans['popup-details-link']}</a></p>`;
                        }
                        
                        // Si une image est disponible, créer une mise en page à deux colonnes.
                        if (place.imgUrl && place.imgUrl.trim() !== "") {
                            const safeAlt = escapeHtml(place.frenchName || '');
                            const imageHtml = `
                                <div class="popup-image-wrapper">
                                    <button type="button" class="popup-image-button" aria-label="${trans['popup-image-expand-label']}">
                                        <img src="${place.imgUrl}" alt="${safeAlt}" class="popup-image">
                                    </button>
                                </div>`;

                            return `<div class="popup-layout">
                                        <div class="popup-text-container">${textHtml}</div>
                                        ${imageHtml}
                                    </div>`;
                        }

                        // Sinon, retourner uniquement le texte dans un conteneur de largeur fixe.
                        return `<div class="popup-text-container">${textHtml}</div>`;
                    });
                });

                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [40, 40], maxZoom: focusZoomLevel });
                } else {
                    map.setView(defaultCenter, defaultZoom);
                }
            });
    </script>
</body>
</html>
