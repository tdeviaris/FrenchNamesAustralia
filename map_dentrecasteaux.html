<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>d'Entrecasteaux Map - French Names Along the Australian Coastline</title>
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon16.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Garamond:wght@400;700&family=Lato:wght@300;400&display=swap');
        :root {
            --nav-height: 72px;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; }
        body { 
            font-family: 'Lato', sans-serif; 
            background-color: #f4f4f4; 
            color: #333; 
            padding-top: var(--nav-height); 
        }
        nav {
            background: #1f1f1f;
            color: #fff;
            position: fixed;
            inset: 0 0 auto 0;
            height: var(--nav-height);
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 clamp(18px, 4vw, 40px);
            box-shadow: 0 4px 18px rgba(0,0,0,0.2);
        }
        nav ul { list-style: none; margin: 0; padding: 0; display: flex; gap: clamp(8px, 2vw, 18px); }
        nav ul li a {
            display: block;
            color: inherit;
            text-decoration: none;
            padding: 10px 18px;
            font-size: 1.05rem;
            border-radius: 999px;
            transition: background 0.2s ease, color 0.2s ease;
        }
        nav ul li a.active, nav ul li a:hover { background-color: #0056b3; color: #fff; }
        .lang-switcher {
            position: absolute;
            right: clamp(18px, 4vw, 40px);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.95rem;
        }
        .lang-switcher button {
            background: none;
            border: 2px solid transparent;
            color: inherit;
            cursor: pointer;
            padding: 1px;
            font: inherit;
            border-radius: 4px;
            line-height: 0;
            transition: border-color 0.2s ease;
        }
        .lang-switcher button:hover { border-color: rgba(255, 255, 255, 0.5); }
        .lang-switcher button.active { border-color: #fff; }
        .lang-switcher button:focus-visible { outline: 2px solid #FFD700; outline-offset: 2px; }
        .lang-switcher button img { display: block; width: 28px; height: auto; }
        .lang-switcher .lang-separator { opacity: 0.7; }

        #map {
            width: 100%;
            height: calc(100vh - var(--nav-height));
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .map-info-control {
            background: #fff;
            padding: 4px 10px;
            border-radius: 0;
            box-shadow: none;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.7rem;
            line-height: 1.3;
            color: #333;
            font-family: 'Lato', sans-serif;
            pointer-events: none;
        }
        .leaflet-bottom.leaflet-left .leaflet-control.map-info-control {
            margin: 0;
        }
        .map-info-coordinates { white-space: nowrap; }
        .map-info-scale-wrapper { display: flex; align-items: flex-end; }
        .map-info-scale-wrapper .leaflet-control-scale {
            margin: 0;
            background: transparent;
        }
        .map-info-scale-wrapper .leaflet-control-scale-line {
            background: transparent;
            color: #333;
            border: 1px solid #555;
            border-bottom: none;
            padding: 2px 6px 0;
            border-radius: 0;
            box-shadow: none;
            font-size: 0.7rem;
            line-height: 1.3;
        }
        .leaflet-control-satellite {
            background: rgba(255,255,255,0.8);
            padding: 5px 8px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            backdrop-filter: blur(2px);
        }
        .leaflet-control-satellite label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        .leaflet-popup-content-wrapper { border-radius: 5px; } .leaflet-popup-content { font-size: 0.9rem; line-height: 1.5; width: auto; }
        .leaflet-popup-content p { margin: 3px 0; } .leaflet-popup-content strong { color: #0056b3; }
        .popup-link-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px 12px;
        }
        .popup-link-row .popup-link-separator {
            color: #888;
        }
        .leaflet-popup-content.has-scrollbar {
            overflow-y: auto;
            padding-right: 12px;
            scrollbar-width: thin;
            scrollbar-gutter: stable;
        }
        .leaflet-popup-content.has-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .leaflet-popup-content.has-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.35);
            border-radius: 4px;
        }
        .leaflet-popup-content.has-scrollbar::-webkit-scrollbar-track {
            background-color: rgba(0, 0, 0, 0.08);
            border-radius: 4px;
            margin: 16px 0 12px;
        }
        .leaflet-container .leaflet-popup-close-button {
            right: 14px;
            top: 10px;
        }
        
        /* Styles pour la mise en page de la popup */
        .popup-layout {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        .popup-text-container {
            width: 280px;
            flex-shrink: 0;
        }
        .popup-image-wrapper {
            flex-basis: clamp(240px, 38vw, 360px);
            flex-shrink: 0;
        }
        .popup-image-button {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            width: 100%;
            display: block;
        }
        .popup-image-button:focus-visible {
            outline: 2px solid #FFD700;
            outline-offset: 2px;
        }
        .popup-image-wrapper .popup-image {
            width: 100%;
            height: auto;
            border-radius: 6px;
            display: block;
        }
        @media (max-width: 768px) {
            :root { --nav-height: 60px; }
            body { padding-top: 0; }
            nav {
                height: auto;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 4px 8px;
                padding: 8px 12px;
            }
            .lang-switcher { position: static; }
            nav ul { display: contents; }
            nav ul li a { border-radius: 999px; padding: 6px 10px; font-size: 0.85rem; }
            #map { top: 0; height: 100vh; }
            .leaflet-popup {
                width: 85vw;
                max-width: 380px;
            }
            .leaflet-popup-content-wrapper { width: 100%; }
            .leaflet-popup-content { font-size: 0.8rem; }
            .popup-layout {
                flex-direction: column;
                align-items: stretch;
            }
            .popup-text-container {
                width: 100%;
            }
            .popup-image-wrapper {
                flex-basis: auto;
                width: 100%;
            }
            .popup-image-wrapper .popup-image {
                max-width: 100%;
            }
        }
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
            box-sizing: border-box;
        }
        .image-modal.open { display: flex; }
        .image-modal img {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            background: #fff;
        }
        .image-modal button {
            position: absolute;
            top: 18px;
            right: 18px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: none;
            font-size: 1.5rem;
            line-height: 1;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .image-modal button:focus-visible {
            outline: 2px solid #FFD700;
            outline-offset: 2px;
        }
        .map-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 24px;
            box-sizing: border-box;
        }
        .map-modal.open { display: flex; }
        .map-modal-content {
            background: #fff;
            width: 96vw;
            max-width: 1150px;
            max-height: 92vh;
            display: flex;
            flex-direction: column;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            overflow: hidden;
        }
        .map-modal-header {
            padding: 12px 16px;
            background: #f7f7f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .map-modal-title {
            font-family: 'Lato', sans-serif;
            font-size: 0.95rem;
            font-weight: 400;
            margin: 0;
            color: #333;
        }
        .map-modal-close {
            background: none;
            border: none;
            font-size: 1.6rem;
            line-height: 1;
            cursor: pointer;
            color: #333;
        }
        .map-modal-close:focus-visible {
            outline: 2px solid #0056b3;
            outline-offset: 2px;
        }
        .map-modal-body {
            flex: 1;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            background: #000;
            overflow-y: auto;
            position: relative;
        }
        .map-modal-content {
            position: relative;
        }
        .map-modal-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: rgba(0,0,0,0.78);
            color: #f5f5f5;
            font-family: 'Lato', sans-serif;
            font-size: 0.95rem;
            z-index: 20;
            text-align: center;
            padding: 24px;
            transition: opacity 0.2s ease;
        }
        .map-modal-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .map-modal-overlay .map-modal-spinner-icon {
            width: 56px;
            height: 56px;
            border: 5px solid rgba(255,255,255,0.35);
            border-top-color: #FFD700;
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
        }
        .map-modal-overlay.error .map-modal-spinner-icon {
            border-color: rgba(255,255,255,0.35);
            border-top-color: #f67280;
            animation: none;
        }
        .map-modal-overlay-message {
            margin-top: 4px;
        }
        .map-modal-content-wrapper {
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .map-modal-content-wrapper.visible {
            display: flex;
        }
        .map-modal-body iframe,
        .map-modal-body embed,
        .map-modal-body object {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
        }
        .map-modal-body img {
            width: 100%;
            height: auto;
            display: block;
        }
        .details-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3200;
            padding: 24px;
            box-sizing: border-box;
        }
        .details-modal.open { display: flex; }
        .details-modal-dialog {
            background: #fff;
            width: 90vw;
            max-width: 830px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            box-shadow: 0 12px 32px rgba(0,0,0,0.4);
            overflow: hidden;
        }
        .details-modal-header {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            gap: 16px;
            padding: 8px 18px;
            background: #f7f7f7;
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }
        .details-modal-title {
            font-family: 'Lato', sans-serif;
            font-size: 1.05rem;
            font-weight: 600;
            margin: 0;
            color: #222;
            text-align: center;
        }
        .details-modal-close {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.6rem;
            line-height: 1;
            cursor: pointer;
            color: #333;
            padding: 4px;
        }
        .details-modal-close:focus-visible {
            outline: 2px solid #0056b3;
            outline-offset: 2px;
        }
        .details-modal-body {
            position: relative;
            flex: 1;
            background: #fff;
        }
        .details-modal-loading {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: rgba(255,255,255,0.92);
            color: #333;
            font-family: 'Lato', sans-serif;
            font-size: 0.95rem;
            z-index: 10;
            transition: opacity 0.2s ease;
        }
        .details-modal-loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .details-modal-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #cfd8dc;
            border-top-color: #0056b3;
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
        }
        .details-modal-frame {
            width: 100%;
            height: 100%;
            background: #fff;
            display: block;
            border: none;
        }
    </style>
</head>
<body>
    <nav>
        <ul>
            <li><a href="index.html" id="nav-home">Home</a></li>
            <li><a href="map_dentrecasteaux.html" class="active" id="nav-map-dentre">d'Entrecasteaux Map</a></li>
            <li><a href="map_baudin.html" id="nav-map-baudin">Baudin Map</a></li>
            <li><a href="resources.html" id="nav-resources">Resources</a></li>
        </ul>
        <div class="lang-switcher">
            <button type="button" id="lang-fr" title="Passer en Français">
                <img src="img/fr.svg" alt="Français">
            </button>
            <span aria-hidden="true" class="lang-separator">|</span>
            <button type="button" id="lang-en" title="Switch to English">
                <img src="img/au.svg" alt="English">
            </button>
        </div>
    </nav>

    <div id="map"></div>

    <div id="image-modal" class="image-modal" aria-hidden="true" role="dialog" aria-modal="true">
        <button type="button" id="image-modal-close" aria-label="Fermer l'image">&times;</button>
        <img src="" alt="" id="image-modal-image">
    </div>

    <div id="map-modal" class="map-modal" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="map-modal-content">
            <div class="map-modal-header">
                <h3 class="map-modal-title" id="map-modal-title"></h3>
                <button type="button" class="map-modal-close" id="map-modal-close" aria-label="Close map">&times;</button>
            </div>
            <div class="map-modal-body" id="map-modal-body"></div>
        </div>
    </div>

    <div id="details-modal" class="details-modal" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="details-modal-dialog" tabindex="-1">
            <div class="details-modal-header">
                <h3 class="details-modal-title" id="details-modal-title"></h3>
                <button type="button" class="details-modal-close" id="details-modal-close" aria-label="Close details">&times;</button>
            </div>
            <div class="details-modal-body">
                <div class="details-modal-loading" id="details-modal-loading">
                    <div class="details-modal-spinner" aria-hidden="true"></div>
                    <span id="details-loading-message">Loading…</span>
                </div>
                <iframe id="details-modal-frame" class="details-modal-frame" title="Details" loading="lazy"></iframe>
            </div>
        </div>
    </div>

    <div data-include-footer></div>
    <script src="js/translations.js"></script>
    <script src="js/main.js"></script>
    <script>
        const defaultCenter = [-30.5, 135];
        const defaultZoom = 4;
        const focusZoomLevel = 8;
        const popupTopMargin = 32;
        const popupBottomMargin = 32;
        const popupHeightRatio = 2 / 3;

        const getCurrentLanguage = () => localStorage.getItem('language') || 'en';
        const translate = (key) => translations[getCurrentLanguage()]?.[key] || '';

        const disableMarkerTooltips = (() => {
            const touchPoints = navigator.maxTouchPoints || navigator.msMaxTouchPoints || 0;
            if (touchPoints > 0) {
                return true;
            }
            if ('ontouchstart' in window) {
                return true;
            }
            if (window.matchMedia) {
                if (window.matchMedia('(hover: none)').matches || window.matchMedia('(pointer: coarse)').matches) {
                    return true;
                }
            }
            return false;
        })();

        const map = L.map('map', {
            zoomControl: false // We will add it back in a different position
        }).setView(defaultCenter, defaultZoom);
        L.control.zoom({ position: 'topright' }).addTo(map);

        // --- Layer Control ---
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        });
        const esriImagery = L.esri.basemapLayer('Imagery', { zIndex: 10 });
        const esriLabels  = L.esri.basemapLayer('ImageryLabels', { zIndex: 30 });
        const imageryWithLabels = L.layerGroup([esriImagery, esriLabels]);

        osm.addTo(map);

        const SatelliteControl = L.Control.extend({
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-control-satellite leaflet-control');
                const label = L.DomUtil.create('label', '', container);
                const checkbox = L.DomUtil.create('input', '', label);
                checkbox.type = 'checkbox';
                const span = L.DomUtil.create('span', '', label);
                span.id = 'satellite-label';

                L.DomEvent.disableClickPropagation(container);

                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        map.removeLayer(osm);
                        map.addLayer(imageryWithLabels);
                    } else {
                        map.removeLayer(imageryWithLabels);
                        map.addLayer(osm);
                    }
                });
                
                document.addEventListener('languageChanged', () => { span.textContent = translate('satellite-view-label'); });
                span.textContent = translate('satellite-view-label');

                return container;
            }
        });
        new SatelliteControl({ position: 'topleft' }).addTo(map);

        const scaleControl = L.control.scale({ position: 'bottomleft', metric: true, imperial: false });
        scaleControl.addTo(map);

        let coordinatesElement;
        const mapInfoControl = L.control({ position: 'bottomleft' });
        mapInfoControl.onAdd = () => {
            const container = L.DomUtil.create('div', 'map-info-control');
            coordinatesElement = L.DomUtil.create('div', 'map-info-coordinates', container);
            coordinatesElement.textContent = 'Lat: --°  Lon: --°';

            const scaleWrapper = L.DomUtil.create('div', 'map-info-scale-wrapper', container);
            const scaleContainer = scaleControl._container;
            if (scaleContainer) {
                scaleContainer.classList.remove('leaflet-control');
                scaleWrapper.appendChild(scaleContainer);
            }

            return container;
        };
        mapInfoControl.addTo(map);

        const updateCoordinates = (event) => {
            if (!coordinatesElement) {
                return;
            }
            const { lat, lng } = event.latlng;
            coordinatesElement.textContent = `Lat: ${lat.toFixed(4)}°  Lon: ${lng.toFixed(4)}°`;
        };

        map.on('mousemove', updateCoordinates);
        map.on('mouseout', () => {
            if (coordinatesElement) {
                coordinatesElement.textContent = 'Lat: --°  Lon: --°';
            }
        });

        const enforcePopupMaxHeight = (popup) => {
            if (!popup) {
                return;
            }

            const mapContainer = map.getContainer();
            if (!mapContainer) {
                return;
            }

            const popupElement = popup.getElement();
            if (!popupElement) {
                return;
            }

            const contentElement = popupElement.querySelector('.leaflet-popup-content');
            if (!contentElement) {
                return;
            }

            contentElement.classList.remove('has-scrollbar');
            contentElement.style.maxHeight = '';
            contentElement.style.overflowY = '';

            requestAnimationFrame(() => {
                const refreshedPopup = popup.getElement();
                const refreshedContent = refreshedPopup?.querySelector('.leaflet-popup-content');
                const currentMapHeight = mapContainer.clientHeight;

                if (!refreshedPopup || !refreshedContent || !currentMapHeight) {
                    return;
                }

                const maxPopupHeight = Math.floor(currentMapHeight * popupHeightRatio);
                if (!maxPopupHeight) {
                    return;
                }

                const nonContentHeight = refreshedPopup.offsetHeight - refreshedContent.offsetHeight;
                const allowedContentHeight = Math.max(120, maxPopupHeight - nonContentHeight);

                if (refreshedPopup.offsetHeight <= maxPopupHeight || allowedContentHeight <= 0) {
                    return;
                }

                refreshedContent.style.maxHeight = `${allowedContentHeight}px`;
                refreshedContent.style.overflowY = 'auto';
                refreshedContent.classList.add('has-scrollbar');
            });
        };

        map.on('resize', () => {
            const activePopup = map._popup;
            if (!activePopup) {
                return;
            }
            enforcePopupMaxHeight(activePopup);
            requestAnimationFrame(() => adjustPopupView(activePopup));
        });

        const nameForTooltip = (place, lang) => {
            if (!place) {
                return '';
            }
            if (lang === 'fr') {
                return (place.frenchName || place.ausEName || '').trim();
            }
            return (place.ausEName || place.frenchName || '').trim();
        };

        const isFiniteNumber = (value) => (Number.isFinite ? Number.isFinite(value) : isFinite(value));
        const escapeHtml = (value = '') => String(value).replace(/[&<>"']/g, (char) => {
            const chars = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
            return chars[char] || char;
        });
        const resolveDetailsUrl = (rawValue = '') => {
            const value = (rawValue || '').trim();
            if (!value) {
                return '';
            }
            if (/^(?:https?:|data:|mailto:|#)/i.test(value)) {
                return value;
            }
            if (value.startsWith('details/')) {
                return value;
            }
            return `details/${value}`;
        };

        const extractCoordinates = (place) => {
            const lat = Number(place.lat);
            const lon = Number(place.lon);

            if (!isFiniteNumber(lat) || !isFiniteNumber(lon) || lat === 0 || lon === 0) {
                return null;
            }

            return [lat, lon];
        };
        const formatCoordinates = (lat, lon, trans) => {
            const latValue = Math.abs(lat).toFixed(3);
            const lonValue = Math.abs(lon).toFixed(3);
            const latDir = lat > 0 ? trans['direction-north'] : trans['direction-south'];
            const lonDir = lon > 0 ? trans['direction-east'] : trans['direction-west'];
            return `${latValue}° ${latDir}; ${lonValue}° ${lonDir}`;
        };

        const modal = document.getElementById('image-modal');
        const modalImage = document.getElementById('image-modal-image');
        const modalCloseButton = document.getElementById('image-modal-close');

        const mapModal = document.getElementById('map-modal');
        const mapModalBody = document.getElementById('map-modal-body');
        const mapModalTitle = document.getElementById('map-modal-title');
        const mapModalCloseButton = document.getElementById('map-modal-close');
        const mapModalContent = mapModal?.querySelector('.map-modal-content');
        let mapModalOverlay;
        let mapModalOverlaySpinner;
        let mapModalOverlayMessage;
        let mapModalOverlayOpenedAt = 0;
        const placeNamesByUrl = Object.create(null);

        const detailsModal = document.getElementById('details-modal');
        const detailsModalDialog = detailsModal?.querySelector('.details-modal-dialog');
        const detailsModalFrame = document.getElementById('details-modal-frame');
        const detailsModalLoading = document.getElementById('details-modal-loading');
        const detailsModalLoadingMessage = document.getElementById('details-loading-message');
        const detailsModalTitle = document.getElementById('details-modal-title');
        const detailsModalCloseButton = document.getElementById('details-modal-close');

        const ensureMapModalOverlay = () => {
            if (!mapModalContent) { return null; }
            if (!mapModalOverlay) {
                mapModalOverlay = document.createElement('div');
                mapModalOverlay.className = 'map-modal-overlay hidden';
                mapModalOverlaySpinner = document.createElement('div');
                mapModalOverlaySpinner.className = 'map-modal-spinner-icon';
                mapModalOverlayMessage = document.createElement('span');
                mapModalOverlayMessage.className = 'map-modal-overlay-message';
                mapModalOverlay.append(mapModalOverlaySpinner, mapModalOverlayMessage);
                mapModalContent.appendChild(mapModalOverlay);
            }
            return mapModalOverlay;
        };

        const showMapModalOverlay = (messageKey) => {
            const overlay = ensureMapModalOverlay();
            if (!overlay) { return; }
            const message = translate(messageKey) || translate('map-loading-message') || 'Loading map...';
            mapModalOverlayOpenedAt = performance.now();
            overlay.classList.remove('hidden', 'error');
            if (mapModalOverlayMessage) {
                mapModalOverlayMessage.textContent = message;
            }
        };

        const hideMapModalOverlay = (callback) => {
            const overlay = ensureMapModalOverlay();
            if (!overlay) {
                callback?.();
                return;
            }
            overlay.classList.remove('error');
            const elapsed = performance.now() - mapModalOverlayOpenedAt;
            const minimum = 350;
            const finalize = () => {
                overlay.classList.add('hidden');
                callback?.();
            };
            if (elapsed >= minimum) {
                finalize();
            } else {
                setTimeout(finalize, minimum - elapsed);
            }
        };

        const showMapModalOverlayError = () => {
            const overlay = ensureMapModalOverlay();
            if (!overlay) { return; }
            const message = translate('map-loading-error') || 'Unable to load the map. Please try again.';
            mapModalOverlayOpenedAt = performance.now();
            overlay.classList.remove('hidden');
            overlay.classList.add('error');
            if (mapModalOverlayMessage) {
                mapModalOverlayMessage.textContent = message;
            }
        };

        const closeDetailsModal = () => {
            if (!detailsModal) {
                return;
            }
            detailsModal.classList.remove('open');
            detailsModal.setAttribute('aria-hidden', 'true');
            if (detailsModalFrame) {
                detailsModalFrame.src = 'about:blank';
            }
            if (detailsModalLoading) {
                detailsModalLoading.classList.remove('hidden');
            }
        };

        const openDetailsModal = (rawUrl, title) => {
            const resolvedUrl = resolveDetailsUrl(rawUrl);
            if (!resolvedUrl) {
                return;
            }
            if (!detailsModal || !detailsModalFrame || !detailsModalLoading) {
                window.location.href = resolvedUrl;
                return;
            }

            if (detailsModalTitle) {
                const currentLang = getCurrentLanguage();
                const labels = placeNamesByUrl[resolvedUrl] || {};
                const frLabel = (labels.fr || '').trim();
                const enLabel = (labels.en || '').trim();
                const fallback = (title || '').trim();
                let headerText = '';
                if (frLabel && enLabel) {
                    headerText = currentLang === 'fr'
                        ? `${frLabel} - ${enLabel}`
                        : `${enLabel} - ${frLabel}`;
                } else if (currentLang === 'fr') {
                    headerText = frLabel || enLabel || fallback;
                } else {
                    headerText = enLabel || frLabel || fallback;
                }
                detailsModalTitle.textContent = headerText;
            }
            if (detailsModalCloseButton) {
                detailsModalCloseButton.setAttribute('aria-label', translate('details-close-label') || 'Close');
            }
            if (detailsModalLoadingMessage) {
                detailsModalLoadingMessage.textContent = translate('details-loading-message') || 'Loading page...';
            }

            detailsModalLoading.classList.remove('hidden');
            detailsModal.classList.add('open');
            detailsModal.setAttribute('aria-hidden', 'false');

            if (detailsModalDialog) {
                detailsModalDialog.focus({ preventScroll: true });
            }

            const handleFrameLoad = () => {
                detailsModalLoading.classList.add('hidden');
                detailsModalFrame.removeEventListener('load', handleFrameLoad);
            };

            detailsModalFrame.addEventListener('load', handleFrameLoad);
            detailsModalFrame.setAttribute('title', title || translate('details-frame-title') || 'Details');
            detailsModalFrame.src = resolvedUrl;
        };

        const closeImageModal = () => {
            if (!modal) { return; }
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
            modalImage.src = '';
            modalImage.alt = '';
        };

        const openImageModal = (src, alt) => {
            if (!modal || !modalImage) { return; }
            modalImage.src = src;
            modalImage.alt = alt;
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            if (modalCloseButton) {
                modalCloseButton.focus({ preventScroll: true });
            }
        };

        const closeMapModal = () => {
            if (!mapModal) { return; }
            mapModal.classList.remove('open');
            mapModal.setAttribute('aria-hidden', 'true');
            if (mapModalBody) {
                mapModalBody.innerHTML = '';
            }
            if (mapModalTitle) {
                mapModalTitle.textContent = '';
            }
            hideMapModalOverlay();
        };

        const openMapModal = (url, title) => {
            if (!mapModal || !mapModalBody) { return; }
            const normalizedUrl = (() => {
                if (!url) { return ''; }
                const hasRepresentativeImage = /representativeimage/i.test(url);
                if (!hasRepresentativeImage) {
                    return url;
                }
                if (/wid=\d+/i.test(url)) {
                    return url;
                }
                const separator = url.includes('?') ? '&' : '?';
                return `${url}${separator}wid=2000`;
            })();

            showMapModalOverlay('map-loading-message');

            mapModalBody.innerHTML = '';
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'map-modal-content-wrapper';
            mapModalBody.appendChild(contentWrapper);

            let settled = false;
            const revealContent = () => {
                if (settled) { return; }
                settled = true;
                hideMapModalOverlay(() => {
                    contentWrapper.classList.add('visible');
                });
            };
            const handleError = () => {
                if (settled) { return; }
                settled = true;
                showMapModalOverlayError();
            };

            const isImage = /\.(jpg|jpeg|png|gif|webp)(\?|$)/i.test(normalizedUrl) || /representativeimage/i.test(normalizedUrl);
            if (isImage) {
                const image = new Image();
                image.alt = title || '';
                const attachImage = () => {
                    if (!contentWrapper.contains(image)) {
                        contentWrapper.appendChild(image);
                    }
                    revealContent();
                };
                image.addEventListener('load', () => {
                    if (typeof image.decode === 'function') {
                        image.decode().then(attachImage).catch(attachImage);
                    } else {
                        attachImage();
                    }
                }, { once: true });
                image.addEventListener('error', handleError, { once: true });
                image.src = normalizedUrl;
            } else {
                const frame = document.createElement('iframe');
                frame.src = normalizedUrl;
                frame.title = title || 'Map viewer';
                frame.setAttribute('loading', 'lazy');
                frame.style.visibility = 'hidden';
                contentWrapper.appendChild(frame);
                frame.addEventListener('load', () => {
                    frame.style.visibility = 'visible';
                    revealContent();
                }, { once: true });
                frame.addEventListener('error', handleError, { once: true });
            }

            if (mapModalTitle) {
                mapModalTitle.textContent = title || '';
            }
            mapModal.classList.add('open');
            mapModal.setAttribute('aria-hidden', 'false');
            if (mapModalCloseButton) {
                mapModalCloseButton.focus({ preventScroll: true });
            }
        };

        if (modal) {
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeImageModal();
                }
            });
        }
        if (modalCloseButton) {
            modalCloseButton.addEventListener('click', closeImageModal);
        }
        if (mapModal) {
            mapModal.addEventListener('click', (event) => {
                if (event.target === mapModal) {
                    closeMapModal();
                }
            });
        }
        if (mapModalCloseButton) {
            mapModalCloseButton.addEventListener('click', closeMapModal);
        }
        if (detailsModal) {
            detailsModal.addEventListener('click', (event) => {
                if (event.target === detailsModal) {
                    closeDetailsModal();
                }
            });
        }
        if (detailsModalCloseButton) {
            detailsModalCloseButton.addEventListener('click', closeDetailsModal);
        }
        document.addEventListener('keydown', (event) => {
            if (event.key !== 'Escape') {
                return;
            }
            if (modal?.classList.contains('open')) {
                closeImageModal();
                return;
            }
            if (detailsModal?.classList.contains('open')) {
                closeDetailsModal();
                return;
            }
            if (mapModal?.classList.contains('open')) {
                closeMapModal();
            }
        });

        const adjustPopupView = (popup, attempt = 0) => {
            const marker = popup._source;
            if (!marker) {
                return;
            }

            const targetLatLng = marker.getLatLng();
            const targetZoom = Math.max(map.getZoom(), focusZoomLevel);
            const popupElement = popup.getElement();

            if (!popupElement && attempt < 5) {
                requestAnimationFrame(() => adjustPopupView(popup, attempt + 1));
                return;
            }

            let centerLatLng = targetLatLng;

            if (popupElement) {
                const mapSize = map.getSize();
                const popupHeight = popupElement.offsetHeight;
                const anchorHeight = popupElement.querySelector('.leaflet-popup-tip')?.offsetHeight || 0;

                if (popupHeight) {
                    const markerPixel = map.project(targetLatLng, targetZoom);
                    let desiredMarkerY = markerPixel.y;
                    const popupTop = desiredMarkerY - (popupHeight - anchorHeight);
                    const popupBottom = desiredMarkerY + anchorHeight;

                    if (popupTop < popupTopMargin) {
                        desiredMarkerY += popupTopMargin - popupTop;
                    }
                    if (popupBottom > mapSize.y - popupBottomMargin) {
                        desiredMarkerY -= popupBottom - (mapSize.y - popupBottomMargin);
                    }

                    const centerPixel = [
                        markerPixel.x,
                        markerPixel.y + (mapSize.y / 2) - desiredMarkerY
                    ];
                    centerLatLng = map.unproject(centerPixel, targetZoom);
                }
            }

            const currentCenter = map.getCenter();
            const isSameCenter = currentCenter.distanceTo(centerLatLng) < 1e-6;
            const currentZoom = map.getZoom();

            if (isSameCenter && currentZoom === targetZoom) {
                return;
            }

            map.flyTo(centerLatLng, targetZoom, { duration: 0.45, easeLinearity: 0.2 });
        };

        const attachPopupActions = (popup, attempt = 0) => {
            const popupElement = popup.getElement();
            if (!popupElement && attempt < 5) {
                requestAnimationFrame(() => attachPopupActions(popup, attempt + 1));
                return;
            }
            if (!popupElement) {
                return;
            }
            const button = popupElement.querySelector('.popup-image-button');
            const image = popupElement.querySelector('.popup-image-wrapper .popup-image');
            if (button && image) {
                if (!button.dataset.modalBound) {
                    button.addEventListener('click', () => openImageModal(image.src, image.alt));
                    button.dataset.modalBound = 'true';
                }

                const ensureAdjusted = () => {
                    enforcePopupMaxHeight(popup);
                    requestAnimationFrame(() => adjustPopupView(popup));
                };
                if (image.complete) {
                    requestAnimationFrame(ensureAdjusted);
                } else {
                    image.addEventListener('load', ensureAdjusted, { once: true });
                }
            }

           const mapLink = popupElement.querySelector('.popup-map-link');
           if (mapLink && !mapLink.dataset.modalBound) {
               mapLink.addEventListener('click', (event) => {
                   event.preventDefault();
                   const url = mapLink.dataset.mapUrl;
                   const title = mapLink.dataset.mapTitle || '';
                   if (url && url.trim() !== '') {
                       openMapModal(url, title);
                   }
               });
               mapLink.dataset.modalBound = 'true';
           }

            const detailsLinks = popupElement.querySelectorAll('.popup-details-link');
            detailsLinks.forEach((detailsLink) => {
                if (detailsLink.dataset.detailsBound === 'true') {
                    return;
                }
                detailsLink.addEventListener('click', (event) => {
                    event.preventDefault();
                    const url = detailsLink.dataset.detailsUrl || detailsLink.getAttribute('href') || '';
                    const title = detailsLink.dataset.detailsTitle || detailsLink.textContent || '';
                    openDetailsModal(url, title);
                });
                detailsLink.dataset.detailsBound = 'true';
            });
        };

        map.on('popupopen', (event) => {
            enforcePopupMaxHeight(event.popup);
            requestAnimationFrame(() => adjustPopupView(event.popup));
            attachPopupActions(event.popup);
        });

        const dataVersion = '20250209';
        const dataUrl = `data/entrecasteaux.json?v=${dataVersion}`;

        fetch(dataUrl, { cache: 'no-cache' })
            .then(response => response.json())
            .then(places => {
                const bounds = L.latLngBounds();

                places.forEach(place => {
                    const coordinates = extractCoordinates(place);
                    if (!coordinates) {
                        return;
                    }

                    const [lat, lon] = coordinates;
                    const marker = L.marker([lat, lon]).addTo(map);
                    bounds.extend([lat, lon]);

                    if (!disableMarkerTooltips) {
                        marker.bindTooltip('', {
                            direction: 'top',
                            offset: [0, -10],
                            opacity: 0.95,
                            sticky: true
                        });

                        const refreshTooltip = () => {
                            const currentLang = localStorage.getItem('language') || 'en';
                            const tooltipName = nameForTooltip(place, currentLang);
                            if (!tooltipName) {
                                marker.closeTooltip();
                                return;
                            }
                            marker.setTooltipContent(tooltipName);
                        };

                        marker.on('mouseover', () => {
                            refreshTooltip();
                            if (marker.getTooltip()) {
                                marker.openTooltip();
                            }
                        });
                        marker.on('mouseout', () => marker.closeTooltip());
                    }

                    marker.bindPopup(() => {
                        const currentLang = localStorage.getItem('language') || 'en';
                        const trans = translations[currentLang];
                        const safeAlt = escapeHtml(place.frenchName || '');

                        let textHtml = `<p><strong>${trans['popup-french-name']}</strong> ${place.frenchName}</p>
<p><strong>${trans['popup-ause-name']}</strong> ${place.ausEName}</p>`;

                        if (place.indigenousName && place.indigenousName.trim() !== "") {
                            textHtml += `<p><strong>${trans['popup-indigenous-name']} ${place.indigenousLanguage} :</strong> ${place.indigenousName}</p>`;
                        }

                        const coordinatesText = formatCoordinates(lat, lon, trans);
                        textHtml += `<p><strong>${trans['popup-coordinates']}</strong> ${coordinatesText}</p>`;

                        const detailsUrl = (currentLang === 'fr') ? place.detailsLink : (place.detailsLink_en || place.detailsLink);
                        const linkSegments = [];

                        if (place.mapUrl && place.mapUrl.trim() !== "") {
                            const mapTitle = (currentLang === 'fr' && place.mapTitle_fr) ? place.mapTitle_fr : place.mapTitle_en;
                            const safeMapTitle = mapTitle && mapTitle.trim() !== '' ? escapeHtml(mapTitle) : safeAlt;
                            const safeMapUrl = escapeHtml(place.mapUrl);
                            linkSegments.push(`<a href="#" class="popup-map-link" data-map-url="${safeMapUrl}" data-map-title="${safeMapTitle}">${trans['popup-map-link']}</a>`);
                        }

                        if (detailsUrl && detailsUrl.trim() !== '' && detailsUrl.trim() !== '#') {
                            const resolvedDetailsHref = resolveDetailsUrl(detailsUrl);
                            if (resolvedDetailsHref) {
                                const frLabelRaw = (place.frenchName || '').trim();
                                const enLabelRaw = (place.ausEName || '').trim();
                                if (!placeNamesByUrl[resolvedDetailsHref]) {
                                    placeNamesByUrl[resolvedDetailsHref] = {
                                        fr: frLabelRaw,
                                        en: enLabelRaw
                                    };
                                }
                                const detailsTitle = currentLang === 'fr'
                                    ? (frLabelRaw || enLabelRaw)
                                    : (enLabelRaw || frLabelRaw);
                                linkSegments.push(`<a href="${escapeHtml(resolvedDetailsHref)}" class="popup-details-link" data-details-url="${escapeHtml(resolvedDetailsHref)}" data-details-title="${escapeHtml(detailsTitle)}">${trans['popup-details-link']}</a>`);
                            }
                        }

                        if (linkSegments.length) {
                            textHtml += `<p class="popup-link-row">${linkSegments.join('<span class="popup-link-separator">|</span>')}</p>`;
                        }

                        // Characteristic
                        const characteristicText = (currentLang === 'fr' && place.characteristic_fr) ? place.characteristic_fr : place.characteristic;
                        if (characteristicText && characteristicText.trim() !== "") {
                            textHtml += `<p><strong>${trans['popup-characteristic-label']}</strong> ${characteristicText}</p>`;
                        }

                        // Narrative path / origin of the name
                        const historyText = (currentLang === 'fr' && place.history_fr) ? place.history_fr : place.history;
                        if (historyText && historyText.trim() !== "") {
                            textHtml += `<p><strong>${trans['popup-history-label']}</strong> ${historyText}</p>`;
                        }

                        // Wikipedia link
                        const wikiLink = (currentLang === 'fr') ? place.wiki_fr : place.wiki_en;
                        if (wikiLink && wikiLink.trim() !== "") {
                            let linkText = wikiLink.substring(wikiLink.lastIndexOf('/') + 1);
                            linkText = decodeURIComponent(linkText).replace(/_/g, ' ');
                            textHtml += `<p><strong>${trans['popup-wiki-label']}</strong> <a href="${wikiLink}" target="_blank">${linkText}</a></p>`;
                        }

                        // Other source link
                        if (place.other_link && place.other_link.trim() !== "") {
                            textHtml += `<p><strong>${trans['popup-othersource-label']}</strong> <a href="${place.other_link}" target="_blank">${place.other_link}</a></p>`;
                        }

                        
                        // Si une image est disponible, créer une mise en page à deux colonnes.
                        if (place.imgUrl && place.imgUrl.trim() !== "") {
                            const imageHtml = `
                                <div class="popup-image-wrapper">
                                    <button type="button" class="popup-image-button" aria-label="${trans['popup-image-expand-label']}">
                                        <img src="${place.imgUrl}" alt="${safeAlt}" class="popup-image">
                                    </button>
                                </div>`;

                            return `<div class="popup-layout">
                                        <div class="popup-text-container">${textHtml}</div>
                                        ${imageHtml}
                                    </div>`;
                        }

                        // Sinon, retourner uniquement le texte dans un conteneur de largeur fixe.
                        return `<div class="popup-text-container">${textHtml}</div>`;
                    }, { maxWidth: 700 });
                });

                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [40, 40], maxZoom: focusZoomLevel });
                } else {
                    map.setView(defaultCenter, defaultZoom);
                }
            })
            .catch(error => {
                console.error('Failed to load entrecasteaux data:', error);
            });
    </script>
</body>
</html>
