<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>d'Entrecasteaux Map - French Names Along the Australian Coastline</title>
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon16.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Garamond:wght@400;700&family=Lato:wght@300;400&display=swap');
        :root {
            --nav-height: 72px;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; }
        body { 
            font-family: 'Lato', sans-serif; 
            background-color: #f4f4f4; 
            color: #333; 
            padding-top: var(--nav-height); 
        }
        nav {
            background: #1f1f1f;
            color: #fff;
            position: fixed;
            inset: 0 0 auto 0;
            height: var(--nav-height);
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 clamp(18px, 4vw, 40px);
            box-shadow: 0 4px 18px rgba(0,0,0,0.2);
        }
        nav ul { list-style: none; margin: 0; padding: 0; display: flex; gap: clamp(8px, 2vw, 18px); }
        nav ul li a {
            display: block;
            color: inherit;
            text-decoration: none;
            padding: 10px 18px;
            font-size: 1.05rem;
            border-radius: 999px;
            transition: background 0.2s ease, color 0.2s ease;
        }
        nav ul li a.active, nav ul li a:hover { background-color: #0056b3; color: #fff; }
        .lang-switcher {
            position: absolute;
            right: clamp(18px, 4vw, 40px);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
        }
        .lang-switcher button {
            position: relative;
            background-color: transparent;
            border: none;
            color: inherit;
            cursor: pointer;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        .lang-switcher button:hover {
            background-color: rgba(0, 86, 179, 0.4);
        }
        .lang-switcher button.active {
            background-color: #0056b3;
        }
        .lang-switcher button.active:hover {
            background-color: #0056b3;
        }
        .lang-switcher button:focus-visible { outline: 2px solid #FFD700; outline-offset: 2px; }
        .lang-switcher button img { display: block; width: 28px; height: auto; }

        #map {
            width: 100%;
            height: calc(100vh - var(--nav-height));
        }

        @media (max-width: 1040px) {
            :root { --nav-height: 64px; }
            body { padding-top: var(--nav-height); }
            nav { padding: 0 18px; }
            nav ul { gap: 10px; }
            nav ul li a { padding: 8px 14px; font-size: 0.95rem; }
            .lang-switcher { gap: 8px; }
            .lang-switcher button { width: 38px; height: 38px; }
            .lang-switcher button img { width: 22px; }
        }

        @media (max-width: 880px) {
            :root { --nav-height: 60px; }
            body { padding-top: var(--nav-height); }
            nav { padding: 0 14px; }
            nav ul { gap: 8px; }
            nav ul li a { padding: 7px 12px; font-size: 0.88rem; }
            .lang-switcher { gap: 6px; }
            .lang-switcher button { width: 34px; height: 34px; }
            .lang-switcher button img { width: 20px; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .map-info-control {
            background: #fff;
            padding: 4px 10px;
            border-radius: 0;
            box-shadow: none;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.7rem;
            line-height: 1.3;
            color: #333;
            font-family: 'Lato', sans-serif;
            pointer-events: auto;
            user-select: none;
        }
        .leaflet-bottom.leaflet-left .leaflet-control.map-info-control {
            margin: 0;
        }
        .map-info-coordinates { white-space: nowrap; }
        .map-info-scale-wrapper { display: flex; align-items: baseline; }
        .map-info-scale-wrapper .leaflet-control-scale {
            margin: 0;
            background: transparent;
        }
        .map-info-scale-wrapper .leaflet-control-scale-line {
            background: transparent;
            color: #333;
            border: 1px solid #555;
            border-top: none;
            padding: 0 6px 2px;
            border-radius: 0;
            box-shadow: none;
            font-size: 0.7rem;
            line-height: 1.3;
            margin-top: 3px;
        }
        .map-info-satellite {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 0.7rem;
            line-height: 1.3;
            color: #333;
            font-family: 'Lato', sans-serif;
        }
        .map-info-satellite input {
            width: 14px;
            height: 14px;
            margin: 0;
        }

        /* Search Interface */
        .search-container {
            position: absolute;
            top: calc(var(--nav-height) + 12px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 4px 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(4px);
            min-width: 320px;
        }

        .search-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-family: 'Lato', sans-serif;
            font-size: 0.85rem;
            padding: 2px 4px;
            color: #333;
        }

        .search-input::placeholder {
            color: #888;
        }

        .search-clear {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: #666;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
            display: none;
        }

        .search-clear:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .search-clear.visible {
            display: block;
        }

        .search-button {
            background: none;
            border: none;
            font-size: 1rem;
            color: #0056b3;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
            margin-left: 4px;
        }

        .search-button:hover {
            background-color: rgba(0, 86, 179, 0.1);
        }

        .search-results {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 4px 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(4px);
            font-family: 'Lato', sans-serif;
            font-size: 0.85rem;
            color: #555;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .search-results.visible {
            display: flex;
        }

        .search-nav-button {
            background: rgba(0, 86, 179, 0.8);
            border: none;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-nav-button:hover {
            background-color: #0056b3;
        }

        .search-nav-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .search-container {
                top: 95px;
                left: 50%;
                transform: translateX(-50%);
                width: calc(100% - 40px);
                max-width: 300px;
            }

            .search-box {
                min-width: auto;
                width: 100%;
            }

            .search-input {
                font-size: 16px; /* Prevents iOS auto-zoom */
            }

            .search-results {
                font-size: 0.8rem;
            }
        }

        .leaflet-popup-content-wrapper { border-radius: 5px; } .leaflet-popup-content { font-size: 0.9rem; line-height: 1.5; width: auto; }
        .leaflet-popup-content p { margin: 3px 0; } .leaflet-popup-content strong { color: #0056b3; }
        .popup-link-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px 12px;
        }
        .popup-link-row .popup-link-separator {
            color: #888;
        }
        .leaflet-popup-content.has-scrollbar {
            overflow-y: auto;
            padding-right: 12px;
            scrollbar-width: thin;
            scrollbar-gutter: stable;
        }
        .leaflet-popup-content.has-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .leaflet-popup-content.has-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.35);
            border-radius: 4px;
        }
        .leaflet-popup-content.has-scrollbar::-webkit-scrollbar-track {
            background-color: rgba(0, 0, 0, 0.08);
            border-radius: 4px;
            margin: 16px 0 12px;
        }
        .leaflet-container .leaflet-popup-close-button {
            right: 14px;
            top: 10px;
        }
        
        /* Styles pour la mise en page de la popup */
        .popup-layout {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        .popup-text-container {
            width: 280px;
            flex-shrink: 0;
        }
        .popup-image-wrapper {
            flex-basis: clamp(240px, 38vw, 360px);
            flex-shrink: 0;
        }
        .popup-image-button {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            width: 100%;
            display: block;
        }
        .popup-image-button:focus-visible {
            outline: 2px solid #FFD700;
            outline-offset: 2px;
        }
        .popup-image-wrapper .popup-image {
            width: 100%;
            height: auto;
            border-radius: 6px;
            display: block;
        }
        @media (max-width: 768px) {
            :root { --nav-height: 56px; }
            body { padding-top: var(--nav-height); }
            nav {
                height: var(--nav-height);
                padding: 0 10px;
                justify-content: space-between;
                gap: 6px;
            }
            nav ul {
                display: flex;
                flex: 1;
                justify-content: center;
                gap: 6px;
            }
            nav ul li a {
                padding: 5px 10px;
                font-size: 0.8rem;
            }
            .lang-switcher {
                position: static;
                gap: 4px;
            }
            .lang-switcher button {
                width: 30px;
                height: 30px;
            }
            .lang-switcher button img { width: 18px; }
            #map { height: calc(100vh - var(--nav-height)); }
            .search-container { top: calc(var(--nav-height) + 8px); }
            .leaflet-popup {
                width: 85vw;
                max-width: 380px;
            }
            .leaflet-popup-content-wrapper { width: 100%; }
            .leaflet-popup-content { font-size: 0.8rem; }
            .popup-layout {
                flex-direction: column;
                align-items: stretch;
            }
            .popup-text-container {
                width: 100%;
            }
            .popup-image-wrapper {
                flex-basis: auto;
                width: 100%;
            }
            .popup-image-wrapper .popup-image {
                max-width: 100%;
            }
            .map-info-coordinates {
                display: none;
            }

            /* === Mobile UI Fixes (Attempt 4) === */

            /* 1. Reduce size of map zoom buttons */
            .leaflet-control-zoom a {
                width: 28px;
                height: 28px;
                line-height: 28px;
                font-size: 1.4rem;
            }

            /* 2. Move Satellite control into the bottom bar */
            .leaflet-bottom.leaflet-left {
                display: flex;
                align-items: stretch;
            }

            .map-info-control {
                flex: 1;
                background: rgba(255, 255, 255, 0.95);
                box-shadow: none;
                gap: 8px;
            }

            .map-info-satellite {
                font-size: 0.7rem;
            }
        }
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
            box-sizing: border-box;
        }
        .image-modal.open { display: flex; }
        .image-modal img {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            background: #fff;
        }
        .image-modal button {
            position: absolute;
            top: 18px;
            right: 18px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: none;
            font-size: 1.5rem;
            line-height: 1;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .image-modal button:focus-visible {
            outline: 2px solid #FFD700;
            outline-offset: 2px;
        }
        .map-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 24px;
            box-sizing: border-box;
        }
        .map-modal.open { display: flex; }
        .map-modal-content {
            background: #fff;
            width: 96vw;
            max-width: 1150px;
            max-height: 92vh;
            display: flex;
            flex-direction: column;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            overflow: hidden;
        }
        .map-modal-header {
            padding: 12px 16px;
            background: #f7f7f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .map-modal-title {
            font-family: 'Lato', sans-serif;
            font-size: 0.95rem;
            font-weight: 400;
            margin: 0;
            color: #333;
        }
        .map-modal-close {
            background: none;
            border: none;
            font-size: 1.6rem;
            line-height: 1;
            cursor: pointer;
            color: #333;
        }
        .map-modal-close:focus-visible {
            outline: 2px solid #0056b3;
            outline-offset: 2px;
        }
        .map-modal-body {
            flex: 1;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            background: #000;
            overflow-y: auto;
            position: relative;
        }
        .map-modal-content {
            position: relative;
        }
        .map-modal-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: rgba(0,0,0,0.78);
            color: #f5f5f5;
            font-family: 'Lato', sans-serif;
            font-size: 0.95rem;
            z-index: 20;
            text-align: center;
            padding: 24px;
            transition: opacity 0.2s ease;
        }
        .map-modal-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .map-modal-overlay .map-modal-spinner-icon {
            width: 56px;
            height: 56px;
            border: 5px solid rgba(255,255,255,0.35);
            border-top-color: #FFD700;
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
        }
        .map-modal-overlay.error .map-modal-spinner-icon {
            border-color: rgba(255,255,255,0.35);
            border-top-color: #f67280;
            animation: none;
        }
        .map-modal-overlay-message {
            margin-top: 4px;
        }
        .map-modal-content-wrapper {
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .map-modal-content-wrapper.visible {
            display: flex;
        }
        .map-modal-body iframe,
        .map-modal-body embed,
        .map-modal-body object {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
        }
        .map-modal-body img {
            width: 100%;
            height: auto;
            display: block;
        }
        .details-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3200;
            padding: 24px;
            box-sizing: border-box;
        }
        .details-modal.open { display: flex; }
        .details-modal-dialog {
            background: #fff;
            width: 90vw;
            max-width: 830px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            box-shadow: 0 12px 32px rgba(0,0,0,0.4);
            overflow: hidden;
        }
        .details-modal-header {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            gap: 16px;
            padding: 8px 18px;
            background: #f7f7f7;
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }
        .details-modal-title {
            font-family: 'Lato', sans-serif;
            font-size: 1.05rem;
            font-weight: 600;
            margin: 0;
            color: #222;
            text-align: center;
        }
        .details-modal-close {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.6rem;
            line-height: 1;
            cursor: pointer;
            color: #333;
            padding: 4px;
        }
        .details-modal-close:focus-visible {
            outline: 2px solid #0056b3;
            outline-offset: 2px;
        }
        .details-modal-body {
            position: relative;
            flex: 1;
            background: #fff;
        }
        .details-modal-loading {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: rgba(255,255,255,0.92);
            color: #333;
            font-family: 'Lato', sans-serif;
            font-size: 0.95rem;
            z-index: 10;
            transition: opacity 0.2s ease;
        }
        .details-modal-loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .details-modal-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #cfd8dc;
            border-top-color: #0056b3;
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
        }
        .details-modal-frame {
            width: 100%;
            height: 100%;
            background: #fff;
            display: block;
            border: none;
        }
    .leaflet-tile-pane .leaflet-layer:last-child {
            font-size: 14px !important;
        }
    </style>
</head>
<body>
    <nav>
        <ul>
            <li><a href="index.html" id="nav-home">Home</a></li>
            <li><a href="map_dentrecasteaux.html" class="active" id="nav-map-dentre">d'Entrecasteaux</a></li>
            <li><a href="map_baudin.html" id="nav-map-baudin">Baudin</a></li>
            <li><a href="resources.html" id="nav-resources">Resources</a></li>
        </ul>
        <div class="lang-switcher">
            <button type="button" id="lang-fr" title="Passer en Fran√ßais">
                <img src="img/fr.svg" alt="Fran√ßais">
            </button>
            <button type="button" id="lang-en" title="Switch to English">
                <img src="img/au.svg" alt="English">
            </button>
        </div>
    </nav>

    <div id="map"></div>

    <!-- Search Interface -->
    <div class="search-container">
        <div class="search-box">
            <input type="text" class="search-input" id="search-input" placeholder="Rechercher un lieu...">
            <button type="button" class="search-clear" id="search-clear" title="Effacer">&times;</button>
            <button type="button" class="search-button" id="search-button" title="Rechercher">üîç</button>
        </div>
        <div class="search-results" id="search-results">
            <button type="button" class="search-nav-button" id="search-prev" title="Pr√©c√©dent">‚Äπ</button>
            <span id="search-count">0 occurrence(s)</span>
            <button type="button" class="search-nav-button" id="search-next" title="Suivant">‚Ä∫</button>
        </div>
    </div>

    <div id="image-modal" class="image-modal" aria-hidden="true" role="dialog" aria-modal="true">
        <button type="button" id="image-modal-close" aria-label="Fermer l'image">&times;</button>
        <img src="" alt="" id="image-modal-image">
    </div>

    <div id="map-modal" class="map-modal" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="map-modal-content">
            <div class="map-modal-header">
                <h3 class="map-modal-title" id="map-modal-title"></h3>
                <button type="button" class="map-modal-close" id="map-modal-close" aria-label="Close map">&times;</button>
            </div>
            <div class="map-modal-body" id="map-modal-body"></div>
        </div>
    </div>

    <div id="details-modal" class="details-modal" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="details-modal-dialog" tabindex="-1">
            <div class="details-modal-header">
                <h3 class="details-modal-title" id="details-modal-title"></h3>
                <button type="button" class="details-modal-close" id="details-modal-close" aria-label="Close details">&times;</button>
            </div>
            <div class="details-modal-body">
                <div class="details-modal-loading" id="details-modal-loading">
                    <div class="details-modal-spinner" aria-hidden="true"></div>
                    <span id="details-loading-message">Loading‚Ä¶</span>
                </div>
                <iframe id="details-modal-frame" class="details-modal-frame" title="Details" loading="lazy"></iframe>
            </div>
        </div>
    </div>

    
    <script src="js/translations.js?v=20241012"></script>
    <script src="js/main.js?v=20241012"></script>
    <script>
        const defaultCenter = [-30.5, 135];
        const defaultZoom = 4;
        const focusZoomLevel = 8;
        const popupTopMargin = 26;
        const popupBottomMargin = 28;
        const popupHeightRatio = 0.78;

        const getPopupOverlayMargins = () => {
            const mapContainer = map.getContainer();
            if (!mapContainer) {
                return { top: popupTopMargin, bottom: popupBottomMargin };
            }

            const mapRect = mapContainer.getBoundingClientRect();
            let topMargin = popupTopMargin;
            let bottomMargin = popupBottomMargin;

            const searchOverlay = document.querySelector('.search-container');
            if (searchOverlay) {
                const searchRect = searchOverlay.getBoundingClientRect();
                const overlap = Math.max(0, searchRect.bottom - mapRect.top);
                if (overlap > 0) {
                    topMargin = Math.max(topMargin, overlap + 8);
                }
            }

            const bottomOverlay = document.querySelector('.leaflet-bottom.leaflet-left');
            if (bottomOverlay) {
                const bottomRect = bottomOverlay.getBoundingClientRect();
                const overlap = Math.max(0, mapRect.bottom - bottomRect.top);
                if (overlap > 0) {
                    bottomMargin = Math.max(bottomMargin, overlap + 8);
                }
            }

            return { top: topMargin, bottom: bottomMargin };
        };

        const getCurrentLanguage = () => localStorage.getItem('language') || 'en';
        const translate = (key) => translations[getCurrentLanguage()]?.[key] || '';

        const disableMarkerTooltips = (() => {
            const touchPoints = navigator.maxTouchPoints || navigator.msMaxTouchPoints || 0;
            if (touchPoints > 0) {
                return true;
            }
            if ('ontouchstart' in window) {
                return true;
            }
            if (window.matchMedia) {
                if (window.matchMedia('(hover: none)').matches || window.matchMedia('(pointer: coarse)').matches) {
                    return true;
                }
            }
            return false;
        })();

        const map = L.map('map', {
            zoomControl: false, // We will add it back in a different position
            zoomSnap: 0,        // Allow any fractional zoom level for maximum fluidity.
            zoomDelta: 0.5,     // Zoom in/out by 0.5 levels with buttons for less abrupt changes.
            wheelPxPerZoomLevel: 4 // Dramatically increase sensitivity of wheel/trackpad zoom (lower is more sensitive).
        }).setView(defaultCenter, defaultZoom);
        L.control.zoom({ position: 'topright' }).addTo(map);

        // --- Layer Control ---
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        });
        const esriImagery = L.esri.basemapLayer('Imagery', { zIndex: 10 });
        const esriLabels  = L.esri.basemapLayer('ImageryLabels', { zIndex: 30 });
        const imageryWithLabels = L.layerGroup([esriImagery, esriLabels]);

        osm.addTo(map);

        const scaleControl = L.control.scale({ position: 'bottomleft', metric: true, imperial: false });
        scaleControl.addTo(map);

        let coordinatesElement;
        let satelliteLabelElement;
        let satelliteCheckbox;
        const updateSatelliteLabel = () => {
            if (satelliteLabelElement) {
                satelliteLabelElement.textContent = translate('satellite-view-label');
            }
        };
        const mapInfoControl = L.control({ position: 'bottomleft' });
        mapInfoControl.onAdd = () => {
            const container = L.DomUtil.create('div', 'map-info-control');
            coordinatesElement = L.DomUtil.create('div', 'map-info-coordinates', container);
            coordinatesElement.textContent = 'Lat: --¬∞  Long: --¬∞';

            const satelliteWrapper = L.DomUtil.create('label', 'map-info-satellite', container);
            satelliteCheckbox = L.DomUtil.create('input', '', satelliteWrapper);
            satelliteCheckbox.type = 'checkbox';
            satelliteLabelElement = L.DomUtil.create('span', '', satelliteWrapper);
            satelliteLabelElement.id = 'satellite-label';

            L.DomEvent.disableClickPropagation(satelliteWrapper);
            L.DomEvent.disableScrollPropagation(satelliteWrapper);

            satelliteCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    map.removeLayer(osm);
                    map.addLayer(imageryWithLabels);
                } else {
                    map.removeLayer(imageryWithLabels);
                    map.addLayer(osm);
                }
            });

            updateSatelliteLabel();
            document.addEventListener('languageChanged', updateSatelliteLabel);

            const scaleWrapper = L.DomUtil.create('div', 'map-info-scale-wrapper', container);
            const scaleContainer = scaleControl._container;
            if (scaleContainer) {
                scaleContainer.classList.remove('leaflet-control');
                scaleWrapper.appendChild(scaleContainer);
            }

            return container;
        };
        mapInfoControl.onRemove = () => {
            document.removeEventListener('languageChanged', updateSatelliteLabel);
            coordinatesElement = undefined;
            satelliteLabelElement = undefined;
            satelliteCheckbox = undefined;
        };
        mapInfoControl.addTo(map);

        const syncSatelliteToggleWithLayers = () => {
            if (!satelliteCheckbox) {
                return;
            }
            const isImageryActive = map.hasLayer(imageryWithLabels);
            if (satelliteCheckbox.checked !== isImageryActive) {
                satelliteCheckbox.checked = isImageryActive;
            }
        };
        syncSatelliteToggleWithLayers();

        const updateCoordinates = (event) => {
            if (!coordinatesElement) {
                return;
            }
            const { lat, lng } = event.latlng;
            coordinatesElement.textContent = `Lat: ${lat.toFixed(4)}¬∞  Long: ${lng.toFixed(4)}¬∞`;
        };

        map.on('mousemove', updateCoordinates);
        map.on('mouseout', () => {
            if (coordinatesElement) {
                coordinatesElement.textContent = 'Lat: --¬∞  Long: --¬∞';
            }
        });
        map.on('layeradd', syncSatelliteToggleWithLayers);
        map.on('layerremove', syncSatelliteToggleWithLayers);

        const enforcePopupMaxHeight = (popup, callback) => {
            const scheduleCallback = () => {
                if (callback) {
                    requestAnimationFrame(() => callback(popup));
                }
            };

            if (!popup) {
                scheduleCallback();
                return;
            }

            const mapContainer = map.getContainer();
            if (!mapContainer) {
                scheduleCallback();
                return;
            }

            const popupElement = popup.getElement();
            if (!popupElement) {
                scheduleCallback();
                return;
            }

            const contentElement = popupElement.querySelector('.leaflet-popup-content');
            if (!contentElement) {
                scheduleCallback();
                return;
            }

            contentElement.classList.remove('has-scrollbar');
            contentElement.style.maxHeight = '';
            contentElement.style.overflowY = '';

            requestAnimationFrame(() => {
                const refreshedPopup = popup.getElement();
                const refreshedContent = refreshedPopup?.querySelector('.leaflet-popup-content');
                const currentMapHeight = mapContainer.clientHeight;

                if (!refreshedPopup || !refreshedContent || !currentMapHeight) {
                    scheduleCallback();
                    return;
                }

                const { top: dynamicTopMargin, bottom: dynamicBottomMargin } = getPopupOverlayMargins();
                const availableHeight = Math.max(120, currentMapHeight - dynamicTopMargin - dynamicBottomMargin);
                const ratioHeight = Math.floor(currentMapHeight * popupHeightRatio);
                const maxPopupHeight = Math.max(120, Math.min(ratioHeight || availableHeight, availableHeight));
                if (!maxPopupHeight) {
                    scheduleCallback();
                    return;
                }

                const nonContentHeight = refreshedPopup.offsetHeight - refreshedContent.offsetHeight;
                const allowedContentHeight = Math.max(120, maxPopupHeight - nonContentHeight);

                if (refreshedPopup.offsetHeight > maxPopupHeight && allowedContentHeight > 0) {
                    refreshedContent.style.maxHeight = `${allowedContentHeight}px`;
                    refreshedContent.style.overflowY = 'auto';
                    refreshedContent.classList.add('has-scrollbar');
                }

                scheduleCallback();
            });
        };

        map.on('resize', () => {
            const activePopup = map._popup;
            if (!activePopup) {
                return;
            }
            enforcePopupMaxHeight(activePopup, adjustPopupView);
        });

        const nameForTooltip = (place, lang) => {
            if (!place) {
                return '';
            }
            if (lang === 'fr') {
                return (place.frenchName || place.ausEName || '').trim();
            }
            return (place.ausEName || place.frenchName || '').trim();
        };

        const isFiniteNumber = (value) => (Number.isFinite ? Number.isFinite(value) : isFinite(value));
        const escapeHtml = (value = '') => String(value).replace(/[&<>"']/g, (char) => {
            const chars = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
            return chars[char] || char;
        });
        const resolveDetailsUrl = (rawValue = '') => {
            const value = (rawValue || '').trim();
            if (!value) {
                return '';
            }
            if (/^(?:https?:|data:|mailto:|#)/i.test(value)) {
                return value;
            }
            if (value.startsWith('details/')) {
                return value;
            }
            return `details/${value}`;
        };

        const extractCoordinates = (place) => {
            const lat = Number(place.lat);
            const lon = Number(place.lon);

            if (!isFiniteNumber(lat) || !isFiniteNumber(lon) || lat === 0 || lon === 0) {
                return null;
            }

            return [lat, lon];
        };
        const formatCoordinates = (lat, lon, code, trans) => {
            const latValue = Math.abs(lat).toFixed(3);
            const lonValue = Math.abs(lon).toFixed(3);
            const latDir = lat > 0 ? trans['direction-north'] : trans['direction-south'];
            const lonDir = lon > 0 ? trans['direction-east'] : trans['direction-west'];

            // Extract marker number from code (Entre01 -> 01, Baudin001 -> 001)
            const markerNumber = code.replace(/^[A-Za-z]+/, '');

            return `${latValue}¬∞ ${latDir} ${lonValue}¬∞ ${lonDir} #${markerNumber}`;
        };

        const modal = document.getElementById('image-modal');
        const modalImage = document.getElementById('image-modal-image');
        const modalCloseButton = document.getElementById('image-modal-close');

        const mapModal = document.getElementById('map-modal');
        const mapModalBody = document.getElementById('map-modal-body');
        const mapModalTitle = document.getElementById('map-modal-title');
        const mapModalCloseButton = document.getElementById('map-modal-close');
        const mapModalContent = mapModal?.querySelector('.map-modal-content');
        let mapModalOverlay;
        let mapModalOverlaySpinner;
        let mapModalOverlayMessage;
        let mapModalOverlayOpenedAt = 0;
        const placeNamesByUrl = Object.create(null);

        const detailsModal = document.getElementById('details-modal');
        const detailsModalDialog = detailsModal?.querySelector('.details-modal-dialog');
        const detailsModalFrame = document.getElementById('details-modal-frame');
        const detailsModalLoading = document.getElementById('details-modal-loading');
        const detailsModalLoadingMessage = document.getElementById('details-loading-message');
        const detailsModalTitle = document.getElementById('details-modal-title');
        const detailsModalCloseButton = document.getElementById('details-modal-close');

        const ensureMapModalOverlay = () => {
            if (!mapModalContent) { return null; }
            if (!mapModalOverlay) {
                mapModalOverlay = document.createElement('div');
                mapModalOverlay.className = 'map-modal-overlay hidden';
                mapModalOverlaySpinner = document.createElement('div');
                mapModalOverlaySpinner.className = 'map-modal-spinner-icon';
                mapModalOverlayMessage = document.createElement('span');
                mapModalOverlayMessage.className = 'map-modal-overlay-message';
                mapModalOverlay.append(mapModalOverlaySpinner, mapModalOverlayMessage);
                mapModalContent.appendChild(mapModalOverlay);
            }
            return mapModalOverlay;
        };

        const showMapModalOverlay = (messageKey) => {
            const overlay = ensureMapModalOverlay();
            if (!overlay) { return; }
            const message = translate(messageKey) || translate('map-loading-message') || 'Loading map...';
            mapModalOverlayOpenedAt = performance.now();
            overlay.classList.remove('hidden', 'error');
            if (mapModalOverlayMessage) {
                mapModalOverlayMessage.textContent = message;
            }
        };

        const hideMapModalOverlay = (callback) => {
            const overlay = ensureMapModalOverlay();
            if (!overlay) {
                callback?.();
                return;
            }
            overlay.classList.remove('error');
            const elapsed = performance.now() - mapModalOverlayOpenedAt;
            const minimum = 350;
            const finalize = () => {
                overlay.classList.add('hidden');
                callback?.();
            };
            if (elapsed >= minimum) {
                finalize();
            } else {
                setTimeout(finalize, minimum - elapsed);
            }
        };

        const showMapModalOverlayError = () => {
            const overlay = ensureMapModalOverlay();
            if (!overlay) { return; }
            const message = translate('map-loading-error') || 'Unable to load the map. Please try again.';
            mapModalOverlayOpenedAt = performance.now();
            overlay.classList.remove('hidden');
            overlay.classList.add('error');
            if (mapModalOverlayMessage) {
                mapModalOverlayMessage.textContent = message;
            }
        };

        const closeDetailsModal = () => {
            if (!detailsModal) {
                return;
            }
            detailsModal.classList.remove('open');
            detailsModal.setAttribute('aria-hidden', 'true');
            if (detailsModalFrame) {
                detailsModalFrame.src = 'about:blank';
            }
            if (detailsModalLoading) {
                detailsModalLoading.classList.remove('hidden');
            }
        };

        const openDetailsModal = (rawUrl, title) => {
            const resolvedUrl = resolveDetailsUrl(rawUrl);
            if (!resolvedUrl) {
                return;
            }
            if (!detailsModal || !detailsModalFrame || !detailsModalLoading) {
                window.location.href = resolvedUrl;
                return;
            }

            if (detailsModalTitle) {
                const currentLang = getCurrentLanguage();
                const labels = placeNamesByUrl[resolvedUrl] || {};
                const frLabel = (labels.fr || '').trim();
                const enLabel = (labels.en || '').trim();
                const fallback = (title || '').trim();
                let headerText = '';
                if (frLabel && enLabel) {
                    headerText = currentLang === 'fr'
                        ? `${frLabel} - ${enLabel}`
                        : `${enLabel} - ${frLabel}`;
                } else if (currentLang === 'fr') {
                    headerText = frLabel || enLabel || fallback;
                } else {
                    headerText = enLabel || frLabel || fallback;
                }
                detailsModalTitle.textContent = headerText;
            }
            if (detailsModalCloseButton) {
                detailsModalCloseButton.setAttribute('aria-label', translate('details-close-label') || 'Close');
            }
            if (detailsModalLoadingMessage) {
                detailsModalLoadingMessage.textContent = translate('details-loading-message') || 'Loading page...';
            }

            detailsModalLoading.classList.remove('hidden');
            detailsModal.classList.add('open');
            detailsModal.setAttribute('aria-hidden', 'false');

            if (detailsModalDialog) {
                detailsModalDialog.focus({ preventScroll: true });
            }

            const handleFrameLoad = () => {
                detailsModalLoading.classList.add('hidden');
                detailsModalFrame.removeEventListener('load', handleFrameLoad);
            };

            detailsModalFrame.addEventListener('load', handleFrameLoad);
            detailsModalFrame.setAttribute('title', title || translate('details-frame-title') || 'Details');
            detailsModalFrame.src = resolvedUrl;
        };

        const closeImageModal = () => {
            if (!modal) { return; }
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
            modalImage.src = '';
            modalImage.alt = '';
        };

        const openImageModal = (src, alt) => {
            if (!modal || !modalImage) { return; }
            modalImage.src = src;
            modalImage.alt = alt;
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            if (modalCloseButton) {
                modalCloseButton.focus({ preventScroll: true });
            }
        };

        const closeMapModal = () => {
            if (!mapModal) { return; }
            mapModal.classList.remove('open');
            mapModal.setAttribute('aria-hidden', 'true');
            if (mapModalBody) {
                mapModalBody.innerHTML = '';
            }
            if (mapModalTitle) {
                mapModalTitle.textContent = '';
            }
            hideMapModalOverlay();
        };

        const openMapModal = (url, title) => {
            if (!mapModal || !mapModalBody) { return; }
            const normalizedUrl = (() => {
                if (!url) { return ''; }
                const hasRepresentativeImage = /representativeimage/i.test(url);
                if (!hasRepresentativeImage) {
                    return url;
                }
                if (/wid=\d+/i.test(url)) {
                    return url;
                }
                const separator = url.includes('?') ? '&' : '?';
                return `${url}${separator}wid=2000`;
            })();

            showMapModalOverlay('map-loading-message');

            mapModalBody.innerHTML = '';
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'map-modal-content-wrapper';
            mapModalBody.appendChild(contentWrapper);

            let settled = false;
            const revealContent = () => {
                if (settled) { return; }
                settled = true;
                hideMapModalOverlay(() => {
                    contentWrapper.classList.add('visible');
                });
            };
            const handleError = () => {
                if (settled) { return; }
                settled = true;
                showMapModalOverlayError();
            };

            const isImage = /\.(jpg|jpeg|png|gif|webp)(\?|$)/i.test(normalizedUrl) || /representativeimage/i.test(normalizedUrl);
            if (isImage) {
                const image = new Image();
                image.alt = title || '';
                const attachImage = () => {
                    if (!contentWrapper.contains(image)) {
                        contentWrapper.appendChild(image);
                    }
                    revealContent();
                };
                image.addEventListener('load', () => {
                    if (typeof image.decode === 'function') {
                        image.decode().then(attachImage).catch(attachImage);
                    } else {
                        attachImage();
                    }
                }, { once: true });
                image.addEventListener('error', handleError, { once: true });
                image.src = normalizedUrl;
            } else {
                const frame = document.createElement('iframe');
                frame.src = normalizedUrl;
                frame.title = title || 'Map viewer';
                frame.setAttribute('loading', 'lazy');
                frame.style.visibility = 'hidden';
                contentWrapper.appendChild(frame);
                frame.addEventListener('load', () => {
                    frame.style.visibility = 'visible';
                    revealContent();
                }, { once: true });
                frame.addEventListener('error', handleError, { once: true });
            }

            if (mapModalTitle) {
                mapModalTitle.textContent = title || '';
            }
            mapModal.classList.add('open');
            mapModal.setAttribute('aria-hidden', 'false');
            if (mapModalCloseButton) {
                mapModalCloseButton.focus({ preventScroll: true });
            }
        };

        if (modal) {
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeImageModal();
                }
            });
        }
        if (modalCloseButton) {
            modalCloseButton.addEventListener('click', closeImageModal);
        }
        if (mapModal) {
            mapModal.addEventListener('click', (event) => {
                if (event.target === mapModal) {
                    closeMapModal();
                }
            });
        }
        if (mapModalCloseButton) {
            mapModalCloseButton.addEventListener('click', closeMapModal);
        }
        if (detailsModal) {
            detailsModal.addEventListener('click', (event) => {
                if (event.target === detailsModal) {
                    closeDetailsModal();
                }
            });
        }
        if (detailsModalCloseButton) {
            detailsModalCloseButton.addEventListener('click', closeDetailsModal);
        }
        document.addEventListener('keydown', (event) => {
            if (event.key !== 'Escape') {
                return;
            }
            if (modal?.classList.contains('open')) {
                closeImageModal();
                return;
            }
            if (detailsModal?.classList.contains('open')) {
                closeDetailsModal();
                return;
            }
            if (mapModal?.classList.contains('open')) {
                closeMapModal();
            }
        });

        const adjustPopupView = (popup, attempt = 0) => {
            const marker = popup._source;
            if (!marker) {
                return;
            }

            const targetLatLng = marker.getLatLng();
            const targetZoom = Math.max(map.getZoom(), focusZoomLevel);
            const popupElement = popup.getElement();

            if (!popupElement && attempt < 5) {
                requestAnimationFrame(() => adjustPopupView(popup, attempt + 1));
                return;
            }

            const mapSize = map.getSize();
            const markerPixel = map.project(targetLatLng, targetZoom);
            let centerLatLng = targetLatLng;

            if (popupElement && mapSize) {
                const popupHeight = popupElement.offsetHeight;
                const anchorHeight = popupElement.querySelector('.leaflet-popup-tip')?.offsetHeight || 0;

                if (popupHeight && mapSize.y) {
                    const { top: dynamicTopMargin, bottom: dynamicBottomMargin } = getPopupOverlayMargins();
                    const usableHeight = Math.max(0, mapSize.y - dynamicTopMargin - dynamicBottomMargin);
                    const centerLine = dynamicTopMargin + (usableHeight / 2);

                    const baseMarkerY = centerLine + (popupHeight / 2) - anchorHeight;
                    const minMarkerY = popupHeight - anchorHeight + dynamicTopMargin;
                    const maxMarkerY = mapSize.y - dynamicBottomMargin - anchorHeight;

                    let desiredMarkerY = baseMarkerY;
                    if (Number.isFinite(minMarkerY) && Number.isFinite(maxMarkerY) && minMarkerY <= maxMarkerY) {
                        desiredMarkerY = Math.min(Math.max(desiredMarkerY, minMarkerY), maxMarkerY);
                    }

                    const centerPixel = [
                        markerPixel.x,
                        markerPixel.y + (mapSize.y / 2) - desiredMarkerY
                    ];
                    centerLatLng = map.unproject(centerPixel, targetZoom);
                }
            }

            const currentCenter = map.getCenter();
            const isSameCenter = currentCenter.distanceTo(centerLatLng) < 1e-6;
            const currentZoom = map.getZoom();

            if (isSameCenter && currentZoom === targetZoom) {
                return;
            }

            map.flyTo(centerLatLng, targetZoom, { duration: 0.45, easeLinearity: 0.2 });
        };

        const attachPopupActions = (popup, attempt = 0) => {
            const popupElement = popup.getElement();
            if (!popupElement && attempt < 5) {
                requestAnimationFrame(() => attachPopupActions(popup, attempt + 1));
                return;
            }
            if (!popupElement) {
                return;
            }
            const button = popupElement.querySelector('.popup-image-button');
            const image = popupElement.querySelector('.popup-image-wrapper .popup-image');
            if (button && image && !button.dataset.modalBound) {
                button.addEventListener('click', () => openImageModal(image.src, image.alt));
                button.dataset.modalBound = 'true';
            }

           const mapLink = popupElement.querySelector('.popup-map-link');
           if (mapLink && !mapLink.dataset.modalBound) {
               mapLink.addEventListener('click', (event) => {
                   event.preventDefault();
                   const url = mapLink.dataset.mapUrl;
                   const title = mapLink.dataset.mapTitle || '';
                   if (url && url.trim() !== '') {
                       openMapModal(url, title);
                   }
               });
               mapLink.dataset.modalBound = 'true';
           }

            const detailsLinks = popupElement.querySelectorAll('.popup-details-link');
            detailsLinks.forEach((detailsLink) => {
                if (detailsLink.dataset.detailsBound === 'true') {
                    return;
                }
                detailsLink.addEventListener('click', (event) => {
                    event.preventDefault();
                    const url = detailsLink.dataset.detailsUrl || detailsLink.getAttribute('href') || '';
                    const title = detailsLink.dataset.detailsTitle || detailsLink.textContent || '';
                    openDetailsModal(url, title);
                });
                detailsLink.dataset.detailsBound = 'true';
            });
        };

        const centerPopupOnceReady = (popup, attempt = 0) => {
            if (!popup) {
                return;
            }

            const ensureVisible = () => {
                if (!map._popup || map._popup !== popup) {
                    return;
                }
                enforcePopupMaxHeight(popup, adjustPopupView);
            };

            const popupElement = popup.getElement();
            if (!popupElement) {
                if (attempt < 10) {
                    requestAnimationFrame(() => centerPopupOnceReady(popup, attempt + 1));
                }
                return;
            }

            const pendingImages = Array.from(popupElement.querySelectorAll('img')).filter((img) => !img.complete);
            if (pendingImages.length === 0) {
                ensureVisible();
                return;
            }

            let remaining = pendingImages.length;
            let settled = false;
            let timeoutId = window.setTimeout(() => {
                timeoutId = undefined;
                if (!settled) {
                    settled = true;
                    ensureVisible();
                }
            }, 900);

            const settle = () => {
                if (settled) {
                    return;
                }
                remaining -= 1;
                if (remaining <= 0) {
                    if (timeoutId) {
                        window.clearTimeout(timeoutId);
                        timeoutId = undefined;
                    }
                    settled = true;
                    ensureVisible();
                }
            };

            pendingImages.forEach((img) => {
                img.addEventListener('load', settle, { once: true });
                img.addEventListener('error', settle, { once: true });
            });
        };

        map.on('popupopen', (event) => {
            centerPopupOnceReady(event.popup);
            attachPopupActions(event.popup);
        });

        // Search functionality
        let allPlaces = [];
        let allMarkers = [];
        let searchResults = [];
        let currentSearchIndex = 0;

        const searchInput = document.getElementById('search-input');
        const searchClear = document.getElementById('search-clear');
        const searchButton = document.getElementById('search-button');
        const searchResultsDiv = document.getElementById('search-results');
        const searchCount = document.getElementById('search-count');
        const searchPrev = document.getElementById('search-prev');
        const searchNext = document.getElementById('search-next');

        // Normalize text for search (remove accents, lowercase)
        const normalizeText = (text) => {
            if (!text) return '';
            return text.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, ''); // Remove accents
        };

        // Check if all query words match at word beginnings (AND search)
        const matchesWordStart = (text, query) => {
            if (!text || !query) return false;
            const normalizedText = normalizeText(text);
            const normalizedQuery = normalizeText(query);

            // Split query into individual words
            const queryWords = normalizedQuery.split(/\s+/).filter(word => word.length > 0);

            // Split text into words
            const textWords = normalizedText.split(/[\s\-,.'()]+/);

            // All query words must have a matching word start in the text (AND logic)
            return queryWords.every(queryWord =>
                textWords.some(textWord => textWord.startsWith(queryWord))
            );
        };

        // Check if place has valid GPS coordinates
        const hasValidCoordinates = (place) => {
            return place.lat !== 0 || place.lon !== 0;
        };

        // Perform search in specified fields
        const performSearch = (query) => {
            if (!query.trim()) {
                searchResults = [];
                updateSearchUI();
                return;
            }

            const matchingPlaces = allPlaces.filter(place => {
                // First, exclude places without valid GPS coordinates
                if (!hasValidCoordinates(place)) {
                    return false;
                }

                const searchFields = [
                    place.frenchName,
                    place.variantName,
                    place.ausEName,
                    place.characteristic_fr,
                    place.characteristic,
                    place.history_fr,
                    place.history
                ];

                return searchFields.some(field => matchesWordStart(field, query));
            });

            // Simple deduplication by unique code (codes are unique)
            const uniquePlaces = new Map();
            matchingPlaces.forEach(place => {
                if (!uniquePlaces.has(place.code)) {
                    uniquePlaces.set(place.code, place);
                }
            });

            searchResults = Array.from(uniquePlaces.values());
            currentSearchIndex = 0;
            updateSearchUI();

            if (searchResults.length > 0) {
                focusOnResult(0);
            }
        };


        // Update search UI
        const updateSearchUI = () => {
            const count = searchResults.length;
            const trans = translations[getCurrentLanguage()] || {};
            const occurrenceText = count === 1
                ? trans['search-count-singular'] || 'occurrence'
                : trans['search-count-plural'] || 'occurrences';

            let displayText = `${count} ${occurrenceText}`;
            if (count > 0) {
                const currentNum = currentSearchIndex + 1;
                const totalNum = count.toString().padStart(3, ' ');
                displayText = `${currentNum}/${totalNum.trim()} ${occurrenceText}`;
            }

            searchCount.textContent = displayText;
            searchResultsDiv.classList.toggle('visible', count > 0);

            searchPrev.disabled = count === 0 || currentSearchIndex === 0;
            searchNext.disabled = count === 0 || currentSearchIndex === count - 1;
        };

        // Focus on search result
        const focusOnResult = (index) => {
            if (index < 0 || index >= searchResults.length) return;

            currentSearchIndex = index;
            const place = searchResults[index];
            const coordinates = extractCoordinates(place);

            if (coordinates) {
                const [lat, lon] = coordinates;

                // Find the corresponding marker first
                const targetMarker = allMarkers.find(marker => {
                    const markerPlace = marker.place;
                    return markerPlace && markerPlace.code === place.code;
                });

                if (targetMarker) {
                    // Close any open popup first
                    map.closePopup();

                    // Simply open the popup and let Leaflet + adjustPopupView handle positioning
                    // This mimics exactly what happens with manual marker clicks
                    targetMarker.openPopup();
                }
            }

            updateSearchUI();
        };

        // Update translations for search interface
        const updateSearchTranslations = () => {
            const trans = translations[getCurrentLanguage()] || {};
            searchInput.placeholder = trans['search-placeholder'] || 'Search for a place...';
            searchClear.title = trans['search-clear-title'] || 'Clear';
            searchButton.title = trans['search-button-title'] || 'Search';
            searchPrev.title = trans['search-prev-title'] || 'Previous';
            searchNext.title = trans['search-next-title'] || 'Next';
        };

        // Event listeners
        searchInput.addEventListener('input', (e) => {
            const value = e.target.value;
            searchClear.classList.toggle('visible', value.length > 0);

            // Clear search results immediately if input is empty
            if (value.trim().length === 0) {
                searchResults = [];
                updateSearchUI();
            }
            // No automatic search - user must click magnifier
        });

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch(searchInput.value);
            }
        });

        searchButton.addEventListener('click', () => {
            performSearch(searchInput.value);
        });

        searchClear.addEventListener('click', () => {
            searchInput.value = '';
            searchClear.classList.remove('visible');
            searchResults = [];
            updateSearchUI();
            searchInput.focus();
        });

        searchPrev.addEventListener('click', () => {
            if (currentSearchIndex > 0) {
                focusOnResult(currentSearchIndex - 1);
            }
        });

        searchNext.addEventListener('click', () => {
            if (currentSearchIndex < searchResults.length - 1) {
                focusOnResult(currentSearchIndex + 1);
            }
        });

        // Update search interface translations when language changes
        document.addEventListener('DOMContentLoaded', updateSearchTranslations);
        document.getElementById('lang-fr')?.addEventListener('click', () => {
            setTimeout(updateSearchTranslations, 100);
        });
        document.getElementById('lang-en')?.addEventListener('click', () => {
            setTimeout(updateSearchTranslations, 100);
        });

        const dataVersion = '20250209';
        const dataUrl = `data/entrecasteaux.json?v=${dataVersion}`;

        fetch(dataUrl, { cache: 'no-cache' })
            .then(response => response.json())
            .then(places => {
                // Store places for search functionality
                allPlaces = places;
                allMarkers = [];

                const bounds = L.latLngBounds();

                places.forEach(place => {
                    const coordinates = extractCoordinates(place);
                    if (!coordinates) {
                        return;
                    }

                    const [lat, lon] = coordinates;
                    const marker = L.marker([lat, lon]).addTo(map);

                    // Store marker for search functionality
                    marker.place = place;
                    allMarkers.push(marker);

                    bounds.extend([lat, lon]);

                    if (!disableMarkerTooltips) {
                        marker.bindTooltip('', {
                            direction: 'top',
                            offset: [0, -10],
                            opacity: 0.95,
                            sticky: true
                        });

                        const refreshTooltip = () => {
                            const currentLang = localStorage.getItem('language') || 'en';
                            const tooltipName = nameForTooltip(place, currentLang);
                            if (!tooltipName) {
                                marker.closeTooltip();
                                return;
                            }
                            marker.setTooltipContent(tooltipName);
                        };

                        marker.on('mouseover', () => {
                            refreshTooltip();
                            if (marker.getTooltip()) {
                                marker.openTooltip();
                            }
                        });
                        marker.on('mouseout', () => marker.closeTooltip());
                    }

                    marker.bindPopup(() => {
                        const currentLang = localStorage.getItem('language') || 'en';
                        const trans = translations[currentLang];
                        const safeAlt = escapeHtml(place.frenchName || '');

                        let textHtml = `<p><strong>${trans['popup-french-name']}</strong> ${place.frenchName}</p>
<p><strong>${trans['popup-ause-name']}</strong> ${place.ausEName}</p>`;

                        if (place.indigenousName && place.indigenousName.trim() !== "") {
                            textHtml += `<p><strong>${trans['popup-indigenous-name']} ${place.indigenousLanguage} :</strong> ${place.indigenousName}</p>`;
                        }

                        const coordinatesText = formatCoordinates(lat, lon, place.code, trans);
                        textHtml += `<p><strong>${trans['popup-coordinates']}</strong> ${coordinatesText}</p>`;

                        const detailsUrl = (currentLang === 'fr') ? place.detailsLink : (place.detailsLink_en || place.detailsLink);
                        const linkSegments = [];

                        if (place.mapUrl && place.mapUrl.trim() !== "") {
                            const mapTitle = (currentLang === 'fr' && place.mapTitle_fr) ? place.mapTitle_fr : place.mapTitle_en;
                            const safeMapTitle = mapTitle && mapTitle.trim() !== '' ? escapeHtml(mapTitle) : safeAlt;
                            const safeMapUrl = escapeHtml(place.mapUrl);
                            linkSegments.push(`<a href="#" class="popup-map-link" data-map-url="${safeMapUrl}" data-map-title="${safeMapTitle}">${trans['popup-map-link']}</a>`);
                        }

                        if (detailsUrl && detailsUrl.trim() !== '' && detailsUrl.trim() !== '#') {
                            const resolvedDetailsHref = resolveDetailsUrl(detailsUrl);
                            if (resolvedDetailsHref) {
                                const frLabelRaw = (place.frenchName || '').trim();
                                const enLabelRaw = (place.ausEName || '').trim();
                                if (!placeNamesByUrl[resolvedDetailsHref]) {
                                    placeNamesByUrl[resolvedDetailsHref] = {
                                        fr: frLabelRaw,
                                        en: enLabelRaw
                                    };
                                }
                                const detailsTitle = currentLang === 'fr'
                                    ? (frLabelRaw || enLabelRaw)
                                    : (enLabelRaw || frLabelRaw);
                                linkSegments.push(`<a href="${escapeHtml(resolvedDetailsHref)}" class="popup-details-link" data-details-url="${escapeHtml(resolvedDetailsHref)}" data-details-title="${escapeHtml(detailsTitle)}">${trans['popup-details-link']}</a>`);
                            }
                        }

                        if (linkSegments.length) {
                            textHtml += `<p class="popup-link-row">${linkSegments.join('<span class="popup-link-separator">|</span>')}</p>`;
                        }

                        // Characteristic
                        const characteristicText = (currentLang === 'fr' && place.characteristic_fr) ? place.characteristic_fr : place.characteristic;
                        if (characteristicText && characteristicText.trim() !== "") {
                            textHtml += `<p><strong>${trans['popup-characteristic-label']}</strong> ${characteristicText}</p>`;
                        }

                        // Narrative path / origin of the name
                        const historyText = (currentLang === 'fr' && place.history_fr) ? place.history_fr : place.history;
                        if (historyText && historyText.trim() !== "") {
                            textHtml += `<p><strong>${trans['popup-history-label']}</strong> ${historyText}</p>`;
                        }

                        // Wikipedia link
                        const wikiLink = (currentLang === 'fr') ? place.wiki_fr : place.wiki_en;
                        if (wikiLink && wikiLink.trim() !== "") {
                            let linkText = wikiLink.substring(wikiLink.lastIndexOf('/') + 1);
                            linkText = decodeURIComponent(linkText).replace(/_/g, ' ');
                            textHtml += `<p><strong>${trans['popup-wiki-label']}</strong> <a href="${wikiLink}" target="_blank">${linkText}</a></p>`;
                        }

                        // Other source link
                        if (place.other_link && place.other_link.trim() !== "") {
                            textHtml += `<p><strong>${trans['popup-othersource-label']}</strong> <a href="${place.other_link}" target="_blank">${place.other_link}</a></p>`;
                        }

                        
                        // Si une image est disponible, cr√©er une mise en page √† deux colonnes.
                        if (place.imgUrl && place.imgUrl.trim() !== "") {
                            const imageHtml = `
                                <div class="popup-image-wrapper">
                                    <button type="button" class="popup-image-button" aria-label="${trans['popup-image-expand-label']}">
                                        <img src="${place.imgUrl}" alt="${safeAlt}" class="popup-image">
                                    </button>
                                </div>`;

                            return `<div class="popup-layout">
                                        <div class="popup-text-container">${textHtml}</div>
                                        ${imageHtml}
                                    </div>`;
                        }

                        // Sinon, retourner uniquement le texte dans un conteneur de largeur fixe.
                        return `<div class="popup-text-container">${textHtml}</div>`;
                    }, { maxWidth: 700 });
                });

                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [40, 40], maxZoom: focusZoomLevel });
                } else {
                    map.setView(defaultCenter, defaultZoom);
                }

                // Initialize search interface translations
                updateSearchTranslations();
            })
            .catch(error => {
                console.error('Failed to load entrecasteaux data:', error);
            });
    </script>
</body>
</html>
